---
title: "Breathing Together - Group 1"
author: "CÃ©line Pattaroni"
date: "`r format(Sys.Date())`"
output:
  html_document:
    theme: journal
    fig_width: 10
    fig_height: 10
  pdf_document: default
editor_options:
  markdown:
    wrap: 100
---

Copyright (c) 2023, Mucosal Immunology Lab, Monash University, Melbourne, Australia

### Context

### Environment set up

```{r eval=F, warning=F, cache=T}
# Install required packages
packages <- c("vegan",  "ggplot2", "ggpubr", "ggrepel", "ggside", "xlsx", "hydroTSM", "alluvial", "dplyr", "tidyverse", "lubridate", "randomForest", "magrittr", "gtools", "ggcorrplot", "grDevices", "reshape2", "survival", "survminer", "matrixTests", "pathfindR", "paletteer", "microeco", "file2meco", "psych", "MicrobiomeStat", "phyloseq", "decontam", "metagenomeSeq", "microbiome", "limma", "edgeR", "biomaRt", "MultiAssayExperiment", "MOFA2", "ComplexHeatmap")

# Install packages
pak::pkg_install(packages)
```

```{r eval=T, warning=F, cache=T}
# Load packages
library(vegan) # for ecological data analysis
library(phyloseq) # for microbiome data analysis
library(decontam) # for marker gene contamination analysis
library(metagenomeSeq) # for microbiome data analysis
library(microbiome) # for microbiome data analysis
library(limma) # for differential expression analysis
library(edgeR) # for differential expression analysis
library(ggplot2) # for data visualization
library(ggpubr) # for data visualization
library(ggrepel) # for data visualization
library(ggside) # for data visualization
library(xlsx) # for reading and writing Excel files
library(hydroTSM) # for time series analysis
library(alluvial) # for creating alluvial plots
library(dplyr) # for data manipulation
library(tidyverse) # for data manipulation and visualization
library(lubridate) # for date and time manipulation
library(biomaRt) # for accessing biomolecular annotation data
library(randomForest) # for random forest classification and regression
library(magrittr) # for data manipulation
library(MultiAssayExperiment) # for integration of multiple omics datasets
library(MOFA2) # for multi-omics factor analysis
library(gtools) # for string manipulation
library(ggcorrplot) # for correlation matrix visualization
library(grDevices) # for visualization
library(reshape2) # for data reshaping
library(survival) # for survival analysis
library(survminer) # for survival analysis
library(matrixTests) # for correlations on matrices
library(pathfindR) # for pathway analysis
library(ComplexHeatmap) # for heatmaps
library(paletteer) # for color palettes
library(microeco) # for ecological data analysis
library(file2meco) # for processing and analysis of microbial community data

# Remove phyloseq warnings
options(getClass.msg=FALSE)

# Set up global plot style using ggplot2
margin <- theme(plot.margin = unit(c(1, 1, 1, 1), "cm"))
theme_set(theme_pubr(base_size = 10, base_family = "Helvetica"))

# Set random seed for reproducibility
set.seed(2)

# Import custom functions from Functions.R
source("Functions.R")

# Set custom color palettes
custom_palette_2groups <- c("cadetblue4", "lightsalmon2")
custom_palette_age <- c("pink", "plum3", "plum4", "#66475A") 
custom_palette_microbes <- c("#F1D455FF","#D69F3DFF","#825716FF")
custom_palette_omics1 <- c("#E7999DFF","#F1D455FF","#D69F3DFF","#825716FF")
custom_palette_omics2 <- c("#E7999DFF","#C83D43FF","#F1D455FF","#D69F3DFF","#825716FF")
```

# [Metadata]{.underline}

#### 1) Metadata import

Metadata are imported and pre-processed for downstream analysis using the `Metadata.R` script.

```{r eval=T, warning=F, cache=T}
source("../Scripts/Metadata.R")
```

#### 2) Grouping

Grouping is based on parents-reported wheeze in the first year.

```{r eval=T, warning=F, cache=T}
metadata$Group <- metadata$Wheeze1YEAR
table(metadata$Group)
```

#### 3) Classification of available metadata

```{r eval=T, warning=F, cache=T}
# Number of wheezers vs healthy
table(metadata$Wheeze1YEAR)

# Number of wheezers vs healthy for which we also have longitudinal data
table(metadata$Wheeze1YEAR, metadata$Dataset)

# Number of wheezers vs healthy for which we also have acute data
table(!is.na(metadata$BCNasalswabAcute), metadata$Wheeze1YEAR)
```

#### 4) Grouping of covariates

[**Pregnancy and perinatal covariates**]{.underline} relevant for all time points (particularly
early ones) - Delivery mode (Vag/CS) (175/81) `DeliverySimplified` - Gestational age at birth
(numerical) (37-42) `GestAgeBirth` - Weight at birth (kg) (numerical) (2-4.8) `WeightBirthKg` - Any
breastfeeding in the first week (Yes/No) (208/47) `BreastfeedingBirth` - Antibiotics courses during
pregnancy (Yes/No) (196/59) `AbxCoursesPregnancySimplified`

[**Sex and family history of asthma/hayfever covariates**]{.underline} relevant for all time
points - Sex (Male/Female) (133/123) `Gender` - Mother history of asthma (Yes/No) (56/196)
`MotherAsthma` - Father history of asthma (Yes/No) (68/182) `FatherAsthma` - Mother history of hay
fever (Yes/No) (97/158) `MotherHayfever` - Father history of hay fever (Yes/No) (77/177)
`FatherHayfever`

[**Environmental covariates**]{.underline} relevant for 1 year time point - Daycare (Yes/No)
(96/159) `DayCare1YEAR` - Number of people living in the household (numerical) (1-11) `NbHouse` -
Pets (Yes/No) (93/163) `Pets` - Season (autumm/spring/summer/winter) (59/37/52/38) `Season` - Parents smoking (Yes/No) (48/206) `ParentsSmoking`

[**Respiratory symptoms and treatments covariates**]{.underline} relevant for 1 year time point -
Colds (numerical) (0-20) `Colds1YEAR` - Antibiotics courses since born (numerical) (0-5)
`AbxSinceBorn1YEAR1`

[**Wheeze covariates**]{.underline} relevant for 1 year time point, wheeze group only - More than 2
episodes of wheeze reported in the first year (Yes/No) (56/67) `MoreThan2EpisodesWheeze` - Doctor"s
visit for wheeze (Yes/No) (89/167) `DoctorVisitsAsthmaWheeze1YEAR` - Emergency dpt visit for wheeze
(Yes/No) (39/217) `EmergencyVisitsAsthmaWheeze1YEAR` - Hospital admissions for wheeze (Yes/No)
(23/233) `HospitalAdmissionsAsthmaWheeze1YEAR`

#### 5) Alluvial plot of clinical covariates

```{r eval=T, warning=F, cache=T}
# Group metadata by clinical covariates and count frequencies
phenotype <- metadata %>%
  group_by(Wheeze1YEAR,
           DoctorVisitsAsthmaWheeze1YEAR,
           MoreThan2EpisodesWheeze,
           EmergencyVisitsAsthmaWheeze1YEAR,
           HospitalAdmissionsAsthmaWheeze1YEAR) %>%
  summarise(Freq = n())

# Replace NA values with "No"
phenotype[is.na(phenotype)] <- "No"

# Rename column names for readability
colnames(phenotype) <- c("Parents reported wheeze",
                         "Doctors visit for wheeze",
                         "More than 2 episodes",
                         "Emergency dpt visit for wheeze",
                         "Hospital admissions for wheeze",
                         "Freq")

# Create alluvial plot using ggalluvial
alluvial(phenotype[,1:5], freq=phenotype$Freq, border=NA,
         col=ifelse(phenotype$`Parents reported wheeze` == "No", custom_palette_2groups[1], custom_palette_2groups[2]))

# Save alluvial plot as a PDF
pdf("../Figures/Individual/Alluvial_groups.pdf", width = 11, height = 9)

# Create alluvial plot with custom settings
alluvial(phenotype[,1:5], freq=phenotype$Freq, border=NA, cex=1.5, cex.axis=1.5,
         col=ifelse(phenotype$`Parents reported wheeze` == "No", custom_palette_2groups[1], custom_palette_2groups[2]))

# Turn off PDF device
dev.off()
```

#### 6) Covariates

```{r eval=T, warning=F, cache=T}
# Create lists of covariates (continuous or groups depending on the analysis)
covariates.env <- c("DayCare1YEAR", "NbSiblings", "Pets", "Season")
covariates.clinical <- c("Colds1YEAR", "AbxSinceBorn1YEAR")
covariates.genetic <- c("Gender", "MotherHayfever", "FatherHayfever", "MotherAsthma", "FatherAsthma")
covariates.birth <- c("DeliverySimplified", "GestAgeBirth", "WeightBirthKg", "BreastfeedingBirth", "AbxCoursesPregnancySimplified")
covariates.all <- c(covariates.env, covariates.clinical, covariates.genetic, covariates.birth)

# Create lists of features to investigate
covariates.simplified.env <- c("DayCare1YEAR", "NbSiblingsSimplified", "Pets", "Season")
covariates.simplified.clinical <- c("Colds1YEARSimplified", "AbxSinceBorn1YEARSimplified")
covariates.simplified.genetic <- c("Gender", "MotherHayfever", "FatherHayfever", "MotherAsthma", "FatherAsthma")
covariates.simplified.birth <- c("DeliverySimplified", "GestAgeBirthSimplified", "WeightBirthKgSimplified", "BreastfeedingBirth", "AbxCoursesPregnancySimplified")
covariates.simplified.all <- c(covariates.simplified.env, covariates.simplified.clinical, covariates.simplified.genetic, covariates.simplified.birth)

# Table with counts for covariates
m <- metadata[, colnames(metadata) %in% c("Group", covariates.all)]

# Create a contingency table and perform a chi-squared test
table(m$Group, m$Colds)
chisq.test(table(m$Group, m$Colds))
```

# [Microbiome]{.underline}

### MICROBIOME DATA IMPORT

#### 1) Microbial data import

Input files (count tables, taxonomy and trees) for bacterial 16S and fungi ITS were generated with
the [dada2 pipeline](https://github.com/respiratory-immunology-lab/microbiome-dada2).

```{r eval=T, warning=F, cache=T}
# Load count tables, taxonomy, and trees for bacteria
bact.seqtab <- t(data.frame(readRDS("../../dada2-pipeline-16S/seqtab_nochim.rds"))) # Load count table
colnames(bact.seqtab) <- gsub("16S.", "", colnames(bact.seqtab)) # Rename columns
bact.taxonomy <- data.frame(readRDS("../../dada2-pipeline-16S/taxonomy_species.rds")) # Load taxonomy table
bact.taxonomy$ASV <- highest_taxClass(bact.taxonomy) # Add a column with the highest taxonomic class for each ASV
bact.tree <- readRDS("../../dada2-pipeline-16S/tree.rds") # Load phylogenetic tree

# Load count tables, taxonomy, and trees for fungi
fung.seqtab <- t(data.frame(readRDS("../../dada2-pipeline-ITS/seqtab_nochim.rds"))) # Load count table
colnames(fung.seqtab) <- gsub("ITS.", "", colnames(fung.seqtab)) # Rename columns
fung.taxonomy <- data.frame(readRDS("../../dada2-pipeline-ITS/taxonomy.rds")) # Load taxonomy table
fung.taxonomy$ASV <- highest_taxClass(fung.taxonomy) # Add a column with the highest taxonomic class for each ASV
fung.seq <- rownames(fung.taxonomy) # Save sequence IDs
fung.tree <- readRDS("../../dada2-pipeline-ITS/tree.rds") # Load phylogenetic tree

# Reshape taxonomy comparable to bacteria
fung.taxonomy <- data.frame(lapply(fung.taxonomy, function(x) gsub("k__|p__|c__|o__|f__|g__|s__", "", x))) # Remove prefix from taxonomy labels
rownames(fung.taxonomy) <- fung.seq # Rename rows with sequence IDs

# Load viral data
virus.tab <- read.xlsx2("../Viruses/Viral_qPCR_results_summary.xlsx", colIndex=c(1:3), sheetIndex=3) # Load viral data from Excel file
virus.tab <- reshape::cast(virus.tab, Target~Sample, value="CT") # Reshape data to wide format
rownames(virus.tab) <- virus.tab$Target # Rename rows with viral targets
virus.tab <- virus.tab[,-1] # Remove the first column (redundant with row names)
virus.tab <- ifelse(virus.tab=="Undetermined" | virus.tab>40, 0, 1) # Replace non-detects with zeros and detectable values with ones
```

#### 4) Data matching

Data are matched in order to have one row per sample and the corresponding metadata adjusted for a
given time point. Controls are also added at this stage.

```{r eval=T, warning=F, cache=T}
# Metadata preprocessing to have a matching dataframe
source("../Scripts/Metadata_microbiome.R")
```

#### 5) Phyloseq objects

`phyloseq` objects are created, containing all microbial information with matching metadata.

```{r eval=T, warning=F, cache=T}
# Match metadata order with bacterial data
bact.seqtab <- bact.seqtab[, colnames(bact.seqtab) %in% rownames(df)]
df.bact <- df[rownames(df) %in% colnames(bact.seqtab), ]
df.bact <- df.bact[order(match(rownames(df.bact), colnames(bact.seqtab))), ]
identical(rownames(df.bact), colnames(bact.seqtab))

# Match metadata order with fungal data
fung.seqtab <- fung.seqtab[, colnames(fung.seqtab) %in% rownames(df)]
df.fung <- df[rownames(df) %in% colnames(fung.seqtab), ]
df.fung <- df.fung[order(match(rownames(df.fung), colnames(fung.seqtab))), ]
identical(rownames(df.fung), colnames(fung.seqtab))

# Match metadata order with viral data
df.virus <- df[df$VirusBC %in% colnames(virus.tab), ]
rownames(df.virus) <- df.virus$VirusBC
df.virus <- df.virus[order(match(rownames(df.virus), colnames(virus.tab))), ]
identical(rownames(df.virus), colnames(virus.tab))

virus.tax <- as.data.frame(cbind(Kingdom = rep("Virus", nrow(virus.tab)), Species = rownames(virus.tab)))
rownames(virus.tax) <- virus.tax$Species

# Create phyloseq objects
bact <- phyloseq(
  otu_table(bact.seqtab, taxa_are_rows = TRUE),
  sample_data(df.bact),
  tax_table(as.matrix(bact.taxonomy)),
  phy_tree(bact.tree$tree)
)

fung <- phyloseq(
  otu_table(fung.seqtab, taxa_are_rows = TRUE),
  sample_data(df.fung),
  tax_table(as.matrix(fung.taxonomy)),
  phy_tree(fung.tree$tree)
)

vir <- phyloseq(
  otu_table(virus.tab, taxa_are_rows = TRUE),
  sample_data(df.virus),
  tax_table(as.matrix(virus.tax))
)

# Replace ASVs by taxa names (ID column)
taxa_names(bact) <- tax_table(bact)[, "ASV"]
taxa_names(fung) <- tax_table(fung)[, "ASV"]
```

### MICROBIOME DATA PRE-PROCESSING

During preprocessing, samples with a very low read number are removed and samples are decontaminated
based on the negative controls composition (extraction and PCR controls) using the `decontam` R
package.

#### 1) Samples filtering based on read counts (first round)

Samples with less than 500 reads (even negative controls) need to be removed, as chances are high
that they just represent sequencing background.

```{r eval=T, warning=F, cache=T}
minreadsTreshold <- 500

# Remove very low counts samples in bact
nsamples(bact)
bact <- prune_samples(colSums(otu_table(bact)) > minreadsTreshold, bact)
nsamples(bact)

# Remove very low counts samples in fung
nsamples(fung)
fung <- prune_samples(colSums(otu_table(fung)) > minreadsTreshold, fung)
nsamples(fung)

# Number of negative controls before
table(df$NegCtrl)

# Number of negative controls after
table(sample_data(bact)$NegCtrl)
table(sample_data(fung)$NegCtrl)
```

#### 2) Unclassified ASVs removal

If an ASV is not not assigned at Phylum level (`NA`) chances are high that this sequence is not
bacterial (e.g.Â host-derived). These ASVs are removed.

```{r eval=T, warning=F, cache=T}
# Remove unclassifies ASVs in bact
ntaxa(bact)
bact <- subset_taxa(bact, !is.na(Phylum))
ntaxa(bact)

# Remove unclassifies ASVs in fung
ntaxa(fung)
fung <- subset_taxa(fung, !is.na(Phylum))
ntaxa(fung)
```

#### 3) ASVs decontamination

Decontamination is a key step in microbiome data pre-processing (especially when working with low
biomass samples). The `decontam` R package is used. with the `prevalence` method, as no absolute
quantification is available. The threshold can be adjusted depending on the dataset (usually between
0.1 and 0.5 - less strict to more strict).

The function requires a vector (`NegCrl`) to be `TRUE` to distinguish negative controls from the
rest of the samples.

```{r eval=T, warning=F, cache=T}
# Decontamination of bact
bact.contamdf.prev <- isContaminant(bact, method = "prevalence", neg = "NegCtrl", threshold = 0.3)
bact.thresh <- ggplot(bact.contamdf.prev, aes(x = p)) +
  geom_density(fill = adjustcolor(c("darkseagreen"), 0.5), color = "darkseagreen", adjust = 5) +
  geom_vline(xintercept = 0.3, color = "indianred4") +
  ggtitle("Bacteria p density plot")
bact.contam <- bact.contamdf.prev[which(bact.contamdf.prev$contaminant == TRUE),]

# Decontamination of fung
fung.contamdf.prev <- isContaminant(fung, method = "prevalence", neg = "NegCtrl", threshold = 0.3)
fung.thresh <- ggplot(fung.contamdf.prev, aes(x = p)) +
  geom_density(fill = adjustcolor(c("darkseagreen"), 0.5), color = "darkseagreen", adjust = 5) +
  geom_vline(xintercept = 0.3, color = "indianred4") +
  ggtitle("Fungi p density plot")
fung.contam <- fung.contamdf.prev[which(fung.contamdf.prev$contaminant == TRUE),]

# Make a new phyloseq object of presence-absence in negative controls and true samples in bact
bact_pa <- transform_sample_counts(bact, function(abund) 1 * (abund > 0))
bact_pa_neg <- prune_samples(sample_data(bact_pa)$NegCtrl == TRUE, bact_pa)
bact_pa_pos <- prune_samples(sample_data(bact_pa)$NegCtrl == FALSE, bact_pa)

# Make a new phyloseq object of presence-absence in negative controls and true samples in fung
fung_pa <- transform_sample_counts(fung, function(abund) 1 * (abund > 0))
fung_pa_neg <- prune_samples(sample_data(fung_pa)$NegCtrl == TRUE, fung_pa)
fung_pa_pos <- prune_samples(sample_data(fung_pa)$NegCtrl == FALSE, fung_pa)

# Plot contaminants prevalence
contam.plot.bact <- PlotContaminants(bact, bact.contamdf.prev, "Bacteria contaminants ASVs")
contam.plot.fung <- PlotContaminants(fung, fung.contamdf.prev, "Fungi contaminants ASVs")

# Remove contaminant taxa in bact
ntaxa(bact)
bact <- prune_taxa(!(taxa_names(bact) %in% rownames(bact.contam)), bact)
ntaxa(bact)

# Remove contaminant taxa in fung
ntaxa(fung)
fung <- prune_taxa(!(taxa_names(fung) %in% rownames(fung.contam)), fung)
ntaxa(fung)

# Remove control samples
bact <- prune_samples(as.vector(!(sample_data(bact)[, "NegCtrl"])), bact)
fung <- prune_samples(as.vector(!(sample_data(fung)[, "NegCtrl"])), fung)

# Check number of samples
nb.patients <- dim(metadata)[1]

# Save figures
Supp1 <- ggarrange(
  bact.thresh, contam.plot.bact, fung.thresh, contam.plot.fung,
  ncol = 2, nrow = 2, widths = c(1.5, 2)
) + theme(text = element_text(size = 2))

ggsave(
  "../Figures/Supplementary/Decontam.pdf", Supp1,
  width = 20, height = 20, units = "cm", useDingbats = FALSE
)
```

#### 4) Agglomerate closely related ASVs

```{r eval=T, warning=F, cache=T}
# Keep track of objects before agglomeration
bact_noagglo <- bact
fung_noagglo <- fung

# Agglomerate ASVs
bact <- tip_glom(bact, h = 0.05)
fung <- tip_glom(fung, h = 0.05)

# Add full taxonomic information again after tip_glom
bact <- addtaxonomyafteraggregation(bact)
fung <- addtaxonomyafteraggregation(fung)

# Top taxa for agglomeration visualization
top.bact <- "Moraxellaceae"
top.fung <- "Saccharomycetales_fam_Incertae_sedis"

# Trees before agglomeration
bact.beforetree <- plot_tree(prune_taxa(tax_table(bact_noagglo)[,"Family"] %in% top.bact, bact_noagglo),
                              method = "treeonly",
                              plot.margin = 0.99,
                              label.tips = "taxa_names",
                              ladderize = "left",
                              title = "Bacteria before agglomeration")

fung.beforetree <- plot_tree(prune_taxa(tax_table(fung_noagglo)[,"Family"] %in% top.fung, fung_noagglo),
                              method = "treeonly",
                              plot.margin = 0.99,
                              label.tips = "taxa_names",
                              ladderize = "left",
                              title = "Fungi before agglomeration")

bact.aftertree <- plot_tree(prune_taxa(tax_table(bact)[,"Family"] %in% top.bact, bact),
                              method = "treeonly",
                              plot.margin = 0.99,
                              label.tips = "taxa_names",
                              ladderize = "left",
                              title = "Bacteria after agglomeration")

fung.aftertree <- plot_tree(prune_taxa(tax_table(fung)[,"Family"] %in% top.fung, fung),
                              method = "treeonly",
                              plot.margin = 0.99,
                              label.tips = "taxa_names",
                              ladderize = "left",
                              title = "Fungi after agglomeration")

# Save plots
ggsave("../Figures/Supplementary/Agglomeration.pdf",
       ggarrange(bact.beforetree, bact.aftertree, fung.beforetree, fung.aftertree, ncol = 1, nrow = 4),
       width = 60,
       height = 100,
       units = "cm",
       useDingbats = FALSE,
       limitsize = FALSE)
```

#### 6) Prevalence filtering

Prevalence filtering allows the removal of rare ASVs. This steps can greatly improve downstream
analysis such as differential abundance testing and multi-omics data integration.
`mincountsThreshold` represents the minimum ASV count and `prevalenceTheshold` the minimum
proportion of samples that should have the minimum ASV count.

```{r eval=T, warning=F, cache=T}
# Set prevalence filter parameters
prevalenceTheshold <- 0.05
mincountsThreshold <- 1

# Prevalence filtering in bact
ntaxa(bact)
bact <- filter_taxa(bact, function(x) sum(x>mincountsThreshold) > (prevalenceTheshold*length(x)), TRUE)
ntaxa(bact)

# Prevalence filtering in fung
ntaxa(fung)
fung <- filter_taxa(fung, function(x) sum(x>mincountsThreshold) > (prevalenceTheshold*length(x)), TRUE)
ntaxa(fung)
```

#### 5) Samples filtering based on read counts (second round)

At this step, samples with a low number of reads will be removed. The minimum read count threshold
can vary depending on the sample type, the microbial diversity in the sample, whether we are dealing
with 16S/ITS data and other parameters.

```{r eval=T, warning=F, cache=T}
# Set threshold for minimum reads
minreadsThreshold <- 5000

# Filter out samples with read counts below the minimum threshold in bact
cat("Number of samples before filtering in bact:", nsamples(bact), "\n")
bact <- prune_samples(colSums(otu_table(bact)) > minreadsThreshold, bact)
cat("Number of samples after filtering in bact:", nsamples(bact), "\n")

# Filter out samples with read counts below the minimum threshold in fung
cat("Number of samples before filtering in fung:", nsamples(fung), "\n")
fung <- prune_samples(colSums(otu_table(fung)) > minreadsThreshold, fung)
cat("Number of samples after filtering in fung:", nsamples(fung), "\n")
```

#### 7) Alpha diversity calculations

```{r eval=T, warning=F, cache=T}
# Alpha diversity in bact
bact_alpha <- estimate_richness(bact, split=TRUE, measures=c("Shannon", "Observed"))
sample_data(bact)$Shannon <- bact_alpha[,"Shannon"]
sample_data(bact)$Observed <- log(bact_alpha[,"Observed"])

# Alpha diversity in fung
fung_alpha <- estimate_richness(fung, split=TRUE, measures=c("Shannon", "Observed"))
sample_data(fung)$Shannon <- fung_alpha[,"Shannon"]
sample_data(fung)$Observed <- log(fung_alpha[,"Observed"])

# Number of viruses
vir_alpha <- estimate_richness(vir, split=TRUE, measures=c("Observed"))
sample_data(vir)$Observed <- vir_alpha[,1]
```

#### 8) Datasets splitting

The data sets will be split into 1) 1 year data and 2) longitudinal data.

```{r eval=T, warning=F, cache=T}
# Get IDs of patients with longitudinal data
longitudinal.patients <- metadata[metadata$Dataset == "Longitudinal",]$Patient
acute.patients <- na.trim(df[df$Dataset == "1Acute" & df$keepacute == "Yes",]$Patient)
acute.samples <- na.trim(df$BCNasalswabAcute)

# Split datasets for bact
bact.long <- prune_samples(sample_data(bact)$Patient %in% longitudinal.patients, bact)
bact.long.wheeze <- prune_samples(sample_data(bact.long)$Wheeze1YEAR == "Yes", bact.long)
bact.longw1Y <- prune_samples(!(sample_names(bact) %in% acute.samples), bact)
bact.1Y <- prune_samples(sample_data(bact)$Timepoint == "T4-1year" & !(sample_names(bact) %in% acute.samples), bact)
bact.wheeze.1Y <- prune_samples(sample_data(bact.1Y)$Wheeze1YEAR == "Yes", bact.1Y)

# Split datasets for fung
fung.long <- prune_samples(sample_data(fung)$Patient %in% longitudinal.patients, fung)
fung.long.wheeze <- prune_samples(sample_data(fung.long)$Wheeze1YEAR == "Yes", fung.long)
fung.longw1Y <- prune_samples(!(sample_names(fung) %in% acute.samples), fung)
fung.1Y <- prune_samples(sample_data(fung)$Timepoint == "T4-1year" & !(sample_names(fung) %in% acute.samples), fung)
fung.wheeze.1Y <- prune_samples(sample_data(fung.1Y)$Wheeze1YEAR == "Yes", fung.1Y)

# Split datasets for vir
vir.long <- prune_samples(sample_data(vir)$Patient %in% longitudinal.patients, vir)
vir.longw1Y <- prune_samples(sample_data(vir)$Group != "Wheeze acute", vir)
vir.1Y <- prune_samples(sample_data(vir)$Timepoint == "T4-1year" & sample_data(vir)$Group != "Wheeze acute", vir)
vir.wheeze.1Y <- prune_samples(sample_data(vir.1Y)$Wheeze1YEAR == "Yes", vir.1Y)
```

### MICROBIOME LONGITUDINAL INVESTIGATION

Aim : Characterize differences in microbiome diversity and composition with age in wheezers vs
healthy individuals.

#### 1) Alpha diversity analysis

```{r eval=T, warning=F, cache=T}
# Richness with age
(bact.Observed.age <- BoxplotMetadataAge(bact.long, "Observed", "Longitudinal cohort : Nasal bacterial richness with age", "Age (months)", "Observed richness (log)", custom_palette_age))
(fung.Observed.age <- BoxplotMetadataAge(fung.long, "Observed", "Longitudinal cohort : Nasal fungal richness with age", "Age (months)", "Observed richness (log)", custom_palette_age))
(vir.Observed.age <- BoxplotMetadataAge(vir.long, "Observed", "Longitudinal cohort : Nasal viral richness with age", "Age (months)", "Observed richness (log)", custom_palette_age))

# Statistics
bact.Observed.lm <- lm(SampleDataframe(bact.long)$Observed ~ SampleDataframe(bact.long)$TimepointMonth)
summary(bact.Observed.lm)
fung.Observed.lm <- lm(SampleDataframe(fung.long)$Observed ~ SampleDataframe(fung.long)$TimepointMonth)
summary(fung.Observed.lm)
fung.Observed.lm <- lm(SampleDataframe(vir.long)$Observed ~ SampleDataframe(vir.long)$TimepointMonth)
summary(fung.Observed.lm)

# Save plots
ggsave("../Figures/Individual/Long_Alpha_diversity.pdf", ggarrange(bact.Observed.age, fung.Observed.age, vir.Observed.age, common.legend=TRUE, legend="bottom", align="hv"), width=30, height=10, units="cm", useDingbats=FALSE)
```

#### 2) Viruses investigation

```{r eval=T, warning=F, cache=T}
# Transform into any virus
taxa_sums(vir.long)
sample_data(vir.long)$AnyVirus <- ifelse(sample_sums(vir.long) == 0, "No Virus", ifelse(sample_sums(vir.long) == 1, "1 Virus detected", ">1 Viruses detected"))
table(sample_data(vir.long)$AnyVirus, sample_data(vir.long)$Group)
vir.data <- SampleDataframe(vir.long)

# Stacked bar plots of viral detection
(virus.plot.detection.long <- ggplot(vir.data %>% dplyr::count(AnyVirus, TimepointFactor) %>% mutate(pct = n / sum(n) * 100),
                               aes(TimepointFactor, pct, fill = AnyVirus)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(title = "Longitudinal cohort : Nasal viral richness with age", x = "TimepointFactor", y = "Percentage of samples") +
  geom_text(aes(label = n), position = position_fill(vjust = 0.5), size = 2) +
  scale_fill_manual(values = c("#BF812D", "#DFC27D", "#F5F5F5")) +
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
    theme(legend.position = c(1, 1), legend.box.background=element_rect(), text=element_text(size=12)))

# Detailed virus data
vir.data.detailed <- cbind(as.data.frame(taxa_sums(phyloseq::subset_samples(vir.long, TimepointFactor == "T1-1week"))),
                           as.data.frame(taxa_sums(phyloseq::subset_samples(vir.long, TimepointFactor == "T2-3months"))),
                           as.data.frame(taxa_sums(phyloseq::subset_samples(vir.long, TimepointFactor == "T3-6months"))),
                           as.data.frame(taxa_sums(phyloseq::subset_samples(vir.long, TimepointFactor == "T4-1year"))))
colnames(vir.data.detailed) <- levels(vir.data$TimepointFactor)
vir.data.detailed$Virus <- rownames(vir.data.detailed)
vir.data.detailed <- melt(vir.data.detailed)

# Bar plots of detailed virus data
(virus.plot.details.long <- ggplot(vir.data.detailed, aes(x = variable, y = value, fill = Virus)) +
  geom_bar(stat = "identity", position = "fill") +
  geom_text(aes(label = value), position = position_fill(vjust = 0.5), size = 2) +
  labs(title = "Longitudinal cohort : Nasal viral composition with age", x = "Group", y = "% of positive samples for a given virus") +
  scale_y_continuous(labels = function(x) paste0(x * 100, "%")) +
  scale_fill_brewer(palette = "BrBG") +
    theme(legend.position = c(1, 1), legend.box.background=element_rect(), text=element_text(size=12)))

# Save plots
ggsave("../Figures/Individual/Long_viruses.pdf",
       ggarrange(virus.plot.detection.long, virus.plot.details.long, legend = "bottom", align = "hv", nrow = 1),
       width = 45, height = 12, units = "cm", useDingbats = FALSE)
```

#### 2) Beta diversity analysis

The weighted Unifrac distance matrix is used to perform Principal Coordinates Analysis (PCoA) on all
datasets.

```{r eval=T, warning=F, cache=T}
# Normalize datasets
bact.logCSS.long <- bact.long
otu_table(bact.logCSS.long) <- otu_table(MRcounts(cumNorm(phyloseq_to_metagenomeSeq(bact.logCSS.long), p = 0.5), norm = TRUE, log = TRUE), taxa_are_rows = TRUE)  

fung.logCSS.long <- fung.long
otu_table(fung.logCSS.long) <- otu_table(MRcounts(cumNorm(phyloseq_to_metagenomeSeq(fung.logCSS.long), p = 0.5), norm = TRUE, log = TRUE), taxa_are_rows = TRUE)  

# Beta diversity
(bact.ordi.long <- PlotOrdinationAge(bact.logCSS.long, "Longitudinal cohort: Nasal bacterial weighted Unifrac PCoA", c(custom_palette_age, custom_palette_2groups)))
(fung.ordi.long <- PlotOrdinationAge(fung.logCSS.long, "Longitudinal cohort: Nasal fungal weighted Unifrac PCoA", custom_palette_age))

# Save plots
ggsave("../Figures/Individual/Long_Beta_diversity.pdf",
  ggarrange(bact.ordi.long, fung.ordi.long, common.legend = TRUE, legend = "bottom", align = "hv"),
  width = 40,
  height = 20,
  units = "cm",
  useDingbats = FALSE)
```

#### 3) Distance from previous timepoint

```{r eval=T, warning=F, cache=T}
(bact.long.distance <- PlotUnifracTimepoint(bact.logCSS.long,  "Longitudinal cohort: Bacterial paired sample distance"))
(fung.long.distance <- PlotUnifracTimepoint(fung.logCSS.long, "Longitudinal cohort: Fungal paired sample distance"))
```

#### 4) ANOSIM

```{r eval=T, warning=F, cache=T}
ANOSIMunifrac(bact.logCSS.long, "TimepointSimplified")
ANOSIMunifrac(fung.logCSS.long, "TimepointSimplified")
```

#### 5) Differential abundance testing

```{r eval=T, warning=F, cache=T}
# Differential abundance testing
bact.long.age.meco <- DAtesting(bact.long, c("TimepointFactor", "Patient"), "TimepointFactor+Patient", "ASV")
sort(table(as.data.frame(bact.long.age.meco$res_diff[bact.long.age.meco$res_diff$Significance!="ns",])$Comparison), decreasing = TRUE)
fung.long.age.meco <- DAtesting(fung.long, c("TimepointFactor", "Patient"), "TimepointFactor+Patient", "ASV")
sort(table(as.data.frame(fung.long.age.meco$res_diff[fung.long.age.meco$res_diff$Significance!="ns",])$Comparison), decreasing = TRUE)

# Barplot with top results
(bact.long.age.bar <- DAtestingPlotBar(bact.long.age.meco, "T4-1year - T1-1week", c(custom_palette_age[1], custom_palette_age[4]), 20, "Longitudiunal cohort : Nasal bacterial DA features with age"))
```

### MICROBIOME COVARIATES INVESTIGATION

#### 1) Alpha diversity analysis

```{r eval=T, warning=F, cache=T}
# Alpha diversity versus covariates for bacteria
bact.metadata <- SampleDataframe(bact.1Y)
bact.metadata <- SelectIntoNumeric(bact.metadata, covariates.all)
bact.factors.cor <- cbind(Shannon=SampleDataframe(bact.1Y)$Shannon, Observed=SampleDataframe(bact.1Y)$Observed)
bact.cor <- psych::corr.test(bact.factors.cor, bact.metadata, method="spearman", adjust="fdr")

# Alpha diversity versus covariates for fung
fung.metadata <- SampleDataframe(fung.1Y)
fung.metadata <- SelectIntoNumeric(fung.metadata, covariates.all)
fung.factors.cor <- cbind(Shannon=SampleDataframe(fung.1Y)$Shannon, Observed=SampleDataframe(fung.1Y)$Observed)
fung.cor <- psych::corr.test(fung.factors.cor, fung.metadata, method="spearman", adjust="fdr")

# Alpha diversity versus covariates for vir
vir.metadata <- SampleDataframe(vir.1Y)
vir.metadata <- SelectIntoNumeric(vir.metadata, covariates.all)
vir.factors.cor <- cbind(Shannon=SampleDataframe(vir.1Y)$Shannon, Observed=SampleDataframe(vir.1Y)$Observed)
vir.cor <- psych::corr.test(vir.factors.cor, vir.metadata, method="spearman", adjust="fdr")

# Combine all correlations
all.cor <- rbind(bact.cor$r, fung.cor$r, vir.cor$r)
rownames(all.cor) <- c("Bacterial Diversity", "Bacterial Richness", "Fungal Diversity", "Fungal Richness", "Viral Richness")
colnames(all.cor) <- c("Antibiotics courses during pregnancy", "Any breastfeeding in the first year",
                     "Weight at birth", "Gestational age at birth", "Delivery mode", "Sampling season",
                     "Pets at home", "Number of siblings", "Daycare attendance in the first year", "Father history of asthma",
                     "Mother history of asthma", "Father history of hayfever", "Mother history of hayfever",
                     "Sex", "Antibiotics courses in the first year", "More than 2 colds in the first year")

# Combine all p-values
all.p <- rbind(bact.cor$p, fung.cor$p, vir.cor$p)
rownames(all.p) <- c("Bacterial Diversity", "Bacterial Richness", "Fungal Diversity", "Fungal Richness", "Viral Richness")

# Plot the correlations
(all.cor.factors <- ggcorrplot(all.cor, method="circle", p.mat=all.p, insig="blank", colors=c("indianred4", "white", "#5C1E91")) +
    labs(title="1 year cohort : Alpha diversity correlations with covariates") + scale_y_discrete(labels = str_wrap(colnames(all.cor), width=30)) +
    theme(legend.position = c(1, 0), legend.box.background=element_rect(), axis.text.x=element_text(angle=30), text=element_text(size=12)))

# Save the plot
ggsave("../Figures/Individual/1Y_Covariates_Correlations.pdf", all.cor.factors, width=35, height=20, units="cm", useDingbats=FALSE)
```

```{r eval=T, warning=F, cache=T}
# Add information for each virus
sample_data(vir.1Y)$Adenovirus <- ifelse(OTUDataframe(vir.1Y)["Adenovirus",]>0, "Yes", "No")
sample_data(vir.1Y)$Enterovirus <- ifelse(OTUDataframe(vir.1Y)["Enterovirus",]>0, "Yes", "No")
sample_data(vir.1Y)$Parainfluenza <- ifelse(OTUDataframe(vir.1Y)["Human Parainfluenza",]>0, "Yes", "No")
sample_data(vir.1Y)$Metapneumovirus <- ifelse(OTUDataframe(vir.1Y)["Metapneumovirus",]>0, "Yes", "No")
sample_data(vir.1Y)$Rhinovirus <- ifelse(OTUDataframe(vir.1Y)["Rhinovirus",]>0, "Yes", "No")
sample_data(vir.1Y)$RSV <- ifelse(OTUDataframe(vir.1Y)["RSV",]>0, "Yes", "No")

# Transform into any virus
taxa_sums <- taxa_sums(vir.1Y)
sample_data(vir.1Y)$AnyVirus <- ifelse(sample_sums(vir.1Y)==0, "No Virus", ifelse(sample_sums(vir.1Y)==1, "1 Virus detected", ">1 Viruses detected"))
```

```{r eval=T, warning=F, cache=T}
# Plot significant bacteria alpha diversity
(alpha.bact.colds <- BoxplotMetadataParameters(bact.1Y, "Observed", "Colds1YEARSimplified", "1 year cohort : Nasal bacterial richness with the number of colds in the first year",
                                              "Observed (log)", c(scales::alpha(custom_palette_microbes[1], 0.65), custom_palette_microbes[1]), c(scales::alpha(custom_palette_microbes[1], 0.7), custom_palette_microbes[1])))

(alpha.bact.abx <- BoxplotMetadataParameters(bact.1Y, "Observed", "AbxSinceBorn1YEARSimplified", "1 year cohort : Nasal bacterial richness with antibiotics treatments in the first year",
                                              "Observed (log)", c(scales::alpha(custom_palette_microbes[1], 0.65), custom_palette_microbes[1]), c(scales::alpha(custom_palette_microbes[1], 0.7), custom_palette_microbes[1])))

(alpha.bact.daycare <- BoxplotMetadataParameters(bact.1Y, "Observed", "DayCare1YEAR", "1 year cohort : Bacterial Nasal bichness with daycare attendance",
                                              "Observed (log)", c(scales::alpha(custom_palette_microbes[1], 0.65), custom_palette_microbes[1]), c(scales::alpha(custom_palette_microbes[1], 0.7), custom_palette_microbes[1])))

(alpha.bact.siblings <- BoxplotMetadataParameters(bact.1Y, "Observed", "NbSiblingsSimplified", "1 year cohort : Nasal bacterial richness with siblings number",
                                              "Observed (log)", c(scales::alpha(custom_palette_microbes[1], 0.65), custom_palette_microbes[1]), c(scales::alpha(custom_palette_microbes[1], 0.7), custom_palette_microbes[1])))

# Plot significant fungi alpha diversity
fung.season <- SampleDataframe(ps_drop_incomplete(fung.1Y, "Season"))
fung.season$Season <- as.factor(fung.season$Season)
(alpha.fung.season <- BoxplotMetadataParameters(fung.1Y, "Observed", "Season", "1 year cohort : Nasal fungal diversity with sampling season", "Observed (log)",
                                                c(scales::alpha(custom_palette_microbes[2], 0.50), scales::alpha(custom_palette_microbes[2], 0.75), scales::alpha(custom_palette_microbes[2], 0.90), custom_palette_microbes[2]), 
                                                c(scales::alpha(custom_palette_microbes[2], 0.50), scales::alpha(custom_palette_microbes[2], 0.75), scales::alpha(custom_palette_microbes[2], 0.90), custom_palette_microbes[2])) +
    scale_x_discrete(labels = c(paste0(levels(fung.season$Season)[1], '\n', 'n = ', table(fung.season$Season)[1]),
                                paste0(levels(fung.season$Season)[2], '\n', 'n = ', table(fung.season$Season)[2]),
                                paste0(levels(fung.season$Season)[3], '\n', 'n = ', table(fung.season$Season)[3]),
                                paste0(levels(fung.season$Season)[4], '\n', 'n = ', table(fung.season$Season)[4]))) +
    geom_signif(comparisons=list(c("1-Winter", "3-Summer")),
                map_signif_level=c("***"=0.001/6, "**"=0.01/6, "*"=0.05/6),  y_position=c(4.5, 4)))

# Plot significant viruses alpha diversity
(alpha.vir.daycare <- plotanyViruses(vir.1Y, "DayCare1YEAR", "1 year cohort : Nasal viral richness with daycare attendance"))
(alpha.vir.abx <- plotanyViruses(vir.1Y, "AbxSinceBorn1YEARSimplified", "1 year cohort : Nasal viral richness with antibiotics treatments in the first year"))
(alpha.vir.abxpregnancy <- plotanyViruses(vir.1Y, "AbxCoursesPregnancySimplified", "1 year cohort : Nasal viral richness with antibiotics during pregnancy"))
(alpha.vir.delivery <- plotanyViruses(vir.1Y, "DeliverySimplified", "1 year cohort : Nasal viral richness with delivery mode"))
```

#### 3) dbRDA variables selection

```{r eval=T, warning=F, cache=T}
# Normalize datasets
bact.logCSS.1Y <- bact.1Y
otu_table(bact.logCSS.1Y) <- otu_table(MRcounts(cumNorm(phyloseq_to_metagenomeSeq(bact.logCSS.1Y), p = 0.5), norm = TRUE, log = TRUE), taxa_are_rows = TRUE)  
fung.logCSS.1Y <- fung.1Y
otu_table(fung.logCSS.1Y) <- otu_table(MRcounts(cumNorm(phyloseq_to_metagenomeSeq(fung.logCSS.1Y), p = 0.5), norm = TRUE, log = TRUE), taxa_are_rows = TRUE)  

# Select variables based on dbRDA
bact.1Y.dbrda <- dbRDAselectionUnifrac(bact.logCSS.1Y, covariates.all)
fung.1Y.dbrda <- dbRDAselectionUnifrac(fung.logCSS.1Y, covariates.all)
bact.1Y.dbrda
fung.1Y.dbrda

#bact.1Y.dbrdaS <- dbRDAselectionUnifrac(bact.logCSS.1Y, covariates.simplified.all)
#fung.1Y.dbrdaS <- dbRDAselectionUnifrac(fung.logCSS.1Y, covariates.simplified.all)
#bact.1Y.dbrdaS
#fung.1Y.dbrdaS
```

#### 3) Differential abundance testing

Differential abundance testing is performed for each covariate individually and the number of DA ASVs reported in a dataframe.

```{r eval=T, warning=F, cache=T}
# Calculate the number of DA ASVs for each covariate
bact.1Y.covariates <- DAfeaturesCounts(bact.1Y, covariates.simplified.all, "ASV")
fung.1Y.covariates <- DAfeaturesCounts(fung.1Y, covariates.simplified.all, "ASV")
```

```{r eval=T, warning=F, cache=T}
# New variable names
newnames <- c("Antibiotics courses during pregnancy", "Any breastfeeding in the first year",
              "Weight at birth", "Gestational age at birth", "Delivery mode", 
              "Father history of asthma",  "Mother history of asthma", "Father history of hayfever", "Mother history of hayfever",
              "Sex", "Antibiotics courses in the first year", "More than 2 colds in the first year",
              "Sampling season", "Pets at home", "Number of siblings", "Daycare attendance in the first year")

# Results and reordering
bact.1Y.covariates$Newname <- rev(newnames)
fung.1Y.covariates$Newname <- rev(newnames)

# Plot
(covariates.da.bact.plot <- PlotfeaturesCounts(bact.1Y.covariates, custom_palette_omics2[3], "1 year cohort : Nasal bacterial DA features with covariates"))
(covariates.da.fung.plot <- PlotfeaturesCounts(fung.1Y.covariates, custom_palette_omics2[4], "1 year cohort : Nasal fungal DA features with covariates"))
```


```{r eval=T, warning=F, cache=T}
# Colds variable
bact.da.colds <- DAtesting(bact.1Y, "Colds1YEARSimplified", "~Colds1YEARSimplified", "ASV")
(bact.da.colds.bar <- DAtestingPlotBar(bact.da.colds, "More than 1 colds in the first year - 1 or less colds in the first year", rep(custom_palette_microbes[1],2), 7, "1 year cohort : Nasal bacterial DA features with colds in the first year"))

# Day care variable
bact.da.daycare <- DAtesting(bact.1Y, "DayCare1YEAR", "~DayCare1YEAR", "ASV")
(bact.da.daycare.bar <- DAtestingPlotBar(bact.da.daycare, "Yes daycare - No daycare", rep(custom_palette_microbes[1],2), 17, "1 year cohort : Nasal bacterial DA features with daycare attendance"))

# Siblings variable
bact.da.siblings <- DAtesting(bact.1Y, "NbSiblingsSimplified", "~NbSiblingsSimplified", "ASV")
(bact.da.siblings.bar <- DAtestingPlotBar(bact.da.siblings, "One or more sibling(s) - No siblings", rep(custom_palette_microbes[1],2), 7, "1 year cohort : Nasal bacterial DA features with siblings number"))

# Season
fung.da.season <- DAtesting(fung.1Y, "Season", "~Season", "ASV")
table(fung.da.season$res_diff$Comparison, fung.da.season$res_diff$Significance)
(fung.da.season.bar <- DAtestingPlotBar(fung.da.season, "3-Summer - 1-Winter", rep(custom_palette_microbes[2],2), 11, "1 year cohort : Nasal fungal DA features with sampling season"))
```

### MICROBIOME DISEASE INVESTIGATION

Aim : Characterize differences in microbiome diversity and composition in wheezers vs healthy individuals.

#### 1) Alpha diversity analysis

Alpha diversity metrics summarize the structure of an ecological community with respect to its
richness (number of taxonomic groups), evenness (distribution of abundances of the groups), or both.

```{r eval=T, warning=F, cache=T}
# Bacterial and fungal diversity and richness for 1 year dataset
(bact.Shannon.1Y <- BoxplotMetadataGroup(bact.1Y, "Shannon", "1 year cohort : Nasal bacterial diversity with wheeze", "Shannon diversity", custom_palette_2groups))
(bact.Observed.1Y <- BoxplotMetadataGroup(bact.1Y, "Observed", "1 year cohort : Nasal bacterial richness with wheeze", "Observed richness (log)", custom_palette_2groups))
(fung.Shannon.1Y <- BoxplotMetadataGroup(fung.1Y, "Shannon", "1 year cohort : Nasal fungal diversity with wheeze", "Shannon diversity", custom_palette_2groups))
(fung.Observed.1Y <- BoxplotMetadataGroup(fung.1Y, "Observed", "1 year cohort : Nasal fungal richness with wheeze", "Observed richness (log)", custom_palette_2groups))
(vir.Observed.1Y <- BoxplotMetadataGroup(vir.1Y, "Observed", "1 year cohort : Nasal viral richness with wheeze", "Observed richness (number of detected viruses)", custom_palette_2groups))

# Statistical tests
wilcox.test(SampleDataframe(bact.1Y)$Shannon ~ SampleDataframe(bact.1Y)$Wheeze1YEAR)
wilcox.test(SampleDataframe(bact.1Y)$Observed ~ SampleDataframe(bact.1Y)$Wheeze1YEAR)
wilcox.test(SampleDataframe(fung.1Y)$Shannon ~ SampleDataframe(fung.1Y)$Wheeze1YEAR)
wilcox.test(SampleDataframe(fung.1Y)$Observed ~ SampleDataframe(fung.1Y)$Wheeze1YEAR)
```

#### 2) Viruses investigation

```{r eval=T, warning=F, cache=T}
# Run proportion tests
prop.test(table(sample_data(vir.1Y)$AnyVirus, sample_data(vir.1Y)$Group))
prop.test(table(sample_data(vir.1Y)$Adenovirus, sample_data(vir.1Y)$Group))
prop.test(table(sample_data(vir.1Y)$Enterovirus, sample_data(vir.1Y)$Group))
prop.test(table(sample_data(vir.1Y)$Parainfluenza, sample_data(vir.1Y)$Group))
prop.test(table(sample_data(vir.1Y)$Metapneumovirus, sample_data(vir.1Y)$Group))
prop.test(table(sample_data(vir.1Y)$Rhinovirus, sample_data(vir.1Y)$Group))
prop.test(table(sample_data(vir.1Y)$RSV, sample_data(vir.1Y)$Group))

# Convert to data frame
vir.data <- as.data.frame(SampleDataframe(vir.1Y))

# Stacked bar plots of viral detection
(virus.plot.wheeze <- plotanyViruses(vir.1Y, "Group", "1 year cohort : Nasal viral richness with wheeze"))

# Combine virus data for each group
vir.data.detailed <- cbind(as.data.frame(taxa_sums(phyloseq::subset_samples(vir.1Y, Group=="No"))),
                            as.data.frame(taxa_sums(phyloseq::subset_samples(vir.1Y, Group=="Yes"))))
colnames(vir.data.detailed) <- c("Ctrl", "Wheeze")
vir.data.detailed$Virus <- rownames(vir.data.detailed)
vir.data.detailed <- melt(vir.data.detailed)

# Plot positive viruses by group
(virus.plot.details.wheeze <- ggplot(vir.data.detailed, aes(x = variable, y = value, fill = Virus)) +
    geom_bar(stat = "identity", position = "fill") +
    geom_text(aes(label = value), position = position_fill(vjust = 0.5), size = 5) +
    labs(title = "1 year cohort : Nasal viral composition with wheeze", x = "Group", y = "% of positive samples for a given virus") +
    scale_y_continuous(labels = function(x) paste0(x * 100, "%")) +
    scale_x_discrete(labels = c(paste0("Controls", '\n', 'n = ', table(SampleDataframe(vir.1Y)$Group)[1]),
                             paste0("Wheezers", '\n', 'n = ', table(SampleDataframe(vir.1Y)$Group)[2]))) +
    scale_fill_brewer(palette = "BrBG") +
    theme(legend.position = c(1,0),
          legend.box.background = element_rect(),
          text = element_text(size = 12),
          legend.title = element_blank(),
          legend.text = element_text(size = 10),
          legend.key.size = unit(0.5, "cm")) +
    guides(alpha = "none"))
```

#### 3) Beta diversity analysis

The weighted Unifrac distance matrix is used to perform Principal Coordinates Analysis (PCoA) on all
datasets.

```{r eval=T, warning=F, cache=T}
# Beta diversity
(bact.ordi.1y <- PlotOrdinationGroupUnifrac(bact.logCSS.1Y , "1 year cohort : Nasal bacterial weighted Unifrac PCoA", custom_palette_2groups))
(fung.ordi.1y <- PlotOrdinationGroupUnifrac(fung.logCSS.1Y , "1 year cohort : Nasal fungal weighted Unifrac PCoA", custom_palette_2groups))
```

#### 4) ANOSIM

ANOSIM (ANalysis Of Similarities) is then used to test microbiota composition difference between two
or more groups, based on weighted Unifrac measure.

```{r eval=T, warning=F, cache=T}
ANOSIMunifrac(bact.logCSS.1Y, "Group")
ANOSIMunifrac(fung.logCSS.1Y, "Group")
```

#### 5) Differential abundance testing

```{r eval=T, warning=F, cache=T}
# Differential abundance testing bacteria
bact.da.disease.ASV.adj <- DAtesting(bact.1Y, c("Group", "DayCare1YEAR"),"~Group+DayCare1YEAR", level="ASV")
table(bact.da.disease.ASV.adj$res_diff$Comparison, bact.da.disease.ASV.adj$res_diff$Significance)
bact.da.disease.ASV <- DAtesting(bact.1Y, "Group","~Group", level="ASV")
table(bact.da.disease.ASV$res_diff$Comparison, bact.da.disease.ASV$res_diff$Significance)
(bact.da.disease.adj <- DAtestingPlotBar(bact.da.disease.ASV.adj, "Yes - No", custom_palette_2groups, 7, "1 year cohort : Nasal bacterial DA features with wheeze (adjusted for daycare attendance)"))
(bact.da.disease <- DAtestingPlotBar(bact.da.disease.ASV, "Yes - No", custom_palette_2groups, 14, "1 year cohort : Nasal bacterial DA features with wheeze"))

# Differential abundance testing fungi
fung.da.disease.ASV.adj <- DAtesting(fung.1Y, c("Group", "Season"),"~Group+Season", level="ASV")
table(fung.da.disease.ASV.adj$res_diff$Comparison, fung.da.disease.ASV.adj$res_diff$Significance)
fung.da.disease.ASV <- DAtesting(fung.1Y, "Group","~Group", level="ASV")
table(fung.da.disease.ASV$res_diff$Comparison, fung.da.disease.ASV$res_diff$Significance)
```

### MICROBIOME COMMONALITIES BETWEEN COHORTS

#### 1) DA testing at each timepoint

```{r eval=T, warning=F, cache=T}
# Number of samples at each timepoint for which we have wheeze start month
table(sample_data(bact.long.wheeze)$WheezeStartMonth, sample_data(bact.long.wheeze)$TimepointSimplified)
summary(sample_data(bact.long.wheeze)$WheezeStartMonth)

# Add wheeze status at a given age based on wheeze starting month
sample_data(bact.long)$WheezeStatus <- ifelse(sample_data(bact.long)$TimepointMonth >= sample_data(bact.long)$WheezeStartMonth, TRUE, NA)
sample_data(bact.long)$WheezeStatus <- ifelse(sample_data(bact.long)$Group=="No", FALSE, sample_data(bact.long)$WheezeStatus)

# Add specific Moraxella and Haemophilus levels
sample_data(bact.long)$Moraxella <- OTUDataframe(bact.long)[taxa_names(bact.long)=="Moraxella_catarrhalis_12",]
sample_data(bact.long)$Haemophilus <- OTUDataframe(bact.long)[taxa_names(bact.long)=="Haemophilus_influenzae_19",]
sample_data(bact.long)$DetectedMorax <- ifelse(sample_data(bact.long)$Moraxella>0, "Detected", "Non Detected")
sample_data(bact.long)$DetectedHaemophilus <- ifelse(sample_data(bact.long)$Haemophilus>0, "Detected", "Non Detected")

# Subset age groups
bact.long.birth <- phyloseq::subset_samples(bact.long, Timepoint=="T1-1week")
bact.long.3mo <- phyloseq::subset_samples(bact.long, Timepoint=="T2-3months")
bact.long.6mo <- phyloseq::subset_samples(bact.long, Timepoint=="T3-6months")
bact.long.12mo <- phyloseq::subset_samples(bact.long, Timepoint=="T4-1year")

# DA testing within the age groups
bact.long.birth.group <- DAtesting(bact.long.birth, "Group", "~Group", level="ASV")
table(bact.long.birth.group$res_diff$Significance)
bact.long.3mo.group <- DAtesting(bact.long.3mo, "Group", "~Group", level="ASV")
table(bact.long.3mo.group$res_diff$Significance)
bact.long.6mo.group <- DAtesting(bact.long.6mo, "Group", "~Group", level="ASV")
table(bact.long.6mo.group$res_diff$Significance)
bact.long.12mo.group <- DAtesting(bact.long.12mo, "Group", "~Group", level="ASV")
table(bact.long.12mo.group$res_diff$Significance)
bact.long.birth.status <- DAtesting(bact.long.birth, "WheezeStatus", "~WheezeStatus", level="ASV")
table(bact.long.birth.status$res_diff$Significance)
bact.long.3mo.status <- DAtesting(bact.long.3mo, "WheezeStatus", "~WheezeStatus", level="ASV")
table(bact.long.3mo.status$res_diff$Significance)
bact.long.6mo.status <- DAtesting(bact.long.6mo, "WheezeStatus", "~WheezeStatus", level="ASV")
table(bact.long.6mo.status$res_diff$Significance)
bact.long.12mo.status <- DAtesting(bact.long.12mo, "WheezeStatus", "~WheezeStatus", level="ASV")
table(bact.long.12mo.status$res_diff$Significance)
```

#### 2) Haemophilus detection

```{r eval=T, warning=F, cache=T}
# Add Moraxella_12 levels
sample_data(bact.logCSS.long)$Haemophilus <- OTUDataframe(bact.logCSS.long)[taxa_names(bact.logCSS.long)=="Haemophilus_influenzae_19",]
sample_data(bact.logCSS.long)$DetectedHaemophilus <- ifelse(sample_data(bact.logCSS.long)$Haemophilus>0, TRUE, FALSE)

# Add wheeze status at a given age based on wheeze starting month
sample_data(bact.logCSS.long)$WheezeStatus <- ifelse(sample_data(bact.logCSS.long)$TimepointMonth >= sample_data(bact.logCSS.long)$WheezeStartMonth, "Yes current wheeze", NA)
sample_data(bact.logCSS.long)$WheezeStatus <- ifelse(sample_data(bact.logCSS.long)$Group=="No", "No current wheeze", sample_data(bact.logCSS.long)$WheezeStatus)

# Barplot
data.long <- SampleDataframe(bact.logCSS.long)
data.long <- melt(table(data.long$DetectedHaemophilus, data.long$TimepointFactor, data.long$Group, data.long$WheezeStatus))
colnames(data.long) <- c("HaemophilusDetection", "TimePoint", "Group", "WheezeStatus", "Value")

# Barplot of Haemophilus detection
(Haemophilus.detection.plot <- ggplot(data.long, aes(fill=HaemophilusDetection, x=TimePoint, y=Value)) +
  scale_fill_manual(values=scales::alpha(c("grey", "plum4"), alpha = 0.75)) +
  geom_bar(position="fill", stat="identity") +
  facet_wrap("WheezeStatus") +
    theme(legend.position = c(1, 0), legend.box.background=element_rect(), text=element_text(size=12)))

(Haemophilus.detection.plot <- ggplot(data.long, aes(fill=HaemophilusDetection, x=TimePoint, y=Value)) +
  scale_fill_manual(values=scales::alpha(c("grey", "plum4"), alpha = 0.75)) +
  geom_bar(position="fill", stat="identity") +
  facet_wrap("Group") +
    theme(legend.position = c(1, 0), legend.box.background=element_rect(), text=element_text(size=12)))

# Create dataframe for survival analysis
survival.df <- data.frame(
  time = sample_data(bact.logCSS.long)$TimepointMonth,
  status = sample_data(bact.logCSS.long)$WheezeStatus,
  daycare = sample_data(bact.logCSS.long)$DayCare1YEAR,
  haemophilus = sample_data(bact.logCSS.long)$DetectedHaemophilus,
  group = sample_data(bact.logCSS.long)$Group
)

# Perform survival analysis
fitHaemophilus <- survfit(Surv(time, haemophilus) ~ group, data = survival.df)
summary(fitHaemophilus)
survdiff(Surv(time, haemophilus) ~ group, data = survival.df)

# Survival plots
(Haemophilus.survival.plot <- ggsurvplot(fitHaemophilus, fun = "event", pval = TRUE, conf.int = TRUE, risk.table = FALSE, surv.median.line = "none", palette = custom_palette_2groups)) +
    xlab("Age (months)") + ylab("Proportion of samples within group") +
  ggtitle("Longitudinal cohort : Haemophilus_influenzae_19 positive patients survival analysis with wheeze")

# Plot by timepoint
BoxplotMetadataParameters(bact.logCSS.long, "Haemophilus", "Group", "Haemophilus_influenzae_19", "Haemophilus_influenzae_19 abundance (logCSS)", c(rep("grey"), 4), c(rep("grey", 8))) + facet_wrap(~ TimepointSimplified)
BoxplotMetadataParameters(bact.logCSS.long, "Haemophilus", "WheezeStatus", "Haemophilus_influenzae_19", "Haemophilus_influenzae_19 abundance (logCSS)", c(rep("grey"), 4), c(rep("grey", 8))) + facet_wrap(~ TimepointSimplified)
```

# Gene expression

### HOST DATA IMPORT

#### 1) Metadata import

```{r eval=T, warning=F, cache=T}
# Load metadata and source metadata pre-processing
source("../Scripts/Metadata.R")
metadata$Group <- metadata$Wheeze1YEAR
source("../Scripts/Metadata_host_nasal.R")
source("../Scripts/Metadata_host_blood.R")

# Save a version of metadata with subject number as row name (for later integration)
metaS <- metadata
rownames(metaS) <- paste0("S", metaS$Subjectnumber)
```

#### 2) Gene expression data import

```{r eval=T, warning=F, cache=T}
# Load RNAseq object
identical(rownames(host.nasal), rownames(host.blood))

# Get Ensembl annotations
ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")
ensemblsIDS <- rownames(host.nasal)
list <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol", "gene_biotype"),
              filters = "ensembl_gene_id", values = ensemblsIDS, mart = ensembl)
colnames(list) <- c("gene_id", "hgnc_symbol", "gene_biotype")

# Add gene information
rowData(host.nasal) <- merge(list, rowData(host.nasal), by = "gene_id")
rowData(host.blood) <- merge(list, rowData(host.blood), by = "gene_id")
```

#### 3) Summarized experiment object

```{r eval=T, warning=F, cache=T}
# Check metadata matching
identical(rownames(df.nasal), colnames(host.nasal))
identical(rownames(df.blood.1Y), colnames(host.blood))

# Create DGEList object
host.dge.nasal <- DGEList(counts=assays(host.nasal)$counts, samples=df.nasal, group=df.nasal$Group, genes=rowData(host.nasal), remove.zeros=TRUE)
host.dge.blood <- DGEList(counts=assays(host.blood)$counts, samples=df.blood.1Y, group=df.blood.1Y$Group, genes=rowData(host.blood), remove.zeros=TRUE)
```

### HOST DATA PRE-PROCESSING

#### 1) Filtering and normalization

```{r eval=T, warning=F, cache=T}
# Remove samples with less than 10Mio mapped reads
dim(host.dge.nasal)
host.dge.nasal <- host.dge.nasal[,host.dge.nasal$samples$lib.size>10e6]
dim(host.dge.nasal)
dim(host.dge.blood)
host.dge.blood <- host.dge.blood[,host.dge.blood$samples$lib.size>10e6]
dim(host.dge.blood)

# Normalize and run voom transformation
host.dge.nasal <- calcNormFactors(host.dge.nasal)
host.dge.blood <- calcNormFactors(host.dge.blood)

# Filtering using the design information
design.nasal <- model.matrix(~Group, data = host.dge.nasal$samples)
keep.nasal <- filterByExpr(host.dge.nasal, design.nasal)
host.dge.nasal <- host.dge.nasal[keep.nasal, ]
dim(host.dge.nasal)
design.blood <- model.matrix(~Group, data = host.dge.blood$samples)
keep.blood <- filterByExpr(host.dge.blood, design.blood)
host.dge.blood <- host.dge.blood[keep.blood, ]
dim(host.dge.blood)

# Voom transformation
host.dge.nasal <- voom(host.dge.nasal, design.nasal, plot = TRUE)
host.dge.blood <- voom(host.dge.blood, design.blood, plot = TRUE)

# Select protein coding defined genes only
host.dge.nasal <- host.dge.nasal[host.dge.nasal$genes$gene_biotype == "protein_coding" & host.dge.nasal$genes$hgnc_symbol != "", ]
dim(host.dge.nasal)
host.dge.blood <- host.dge.blood[host.dge.blood$genes$gene_biotype == "protein_coding" & host.dge.blood$genes$hgnc_symbol != "", ]
dim(host.dge.blood)

# Select immune genes only
#ImmuneDB <- read.table("../Databases/InnateDB_genes.csv", sep = ",", header = TRUE)
ImmuneDB <- read.table("../Databases/GeneList.txt", sep = "\t", header = TRUE)
ImmuneDB$name <- ImmuneDB$Symbol
host.dge.nasal$genes$immune <- ifelse(host.dge.nasal$genes$hgnc_symbol %in% ImmuneDB$name, "Yes", "No")
host.dge.blood$genes$immune <- ifelse(host.dge.blood$genes$hgnc_symbol %in% ImmuneDB$name, "Yes", "No")
#host.dge.nasal <- host.dge.nasal[host.dge.nasal$genes$immune =="Yes", ]
dim(host.dge.nasal)
#host.dge.blood <- host.dge.blood[host.dge.blood$genes$immune =="Yes", ]
dim(host.dge.blood)

# Add symbol as rowname
rownames(host.dge.nasal) <- host.dge.nasal$genes$gene_name
rownames(host.dge.blood) <- host.dge.blood$genes$gene_name
```

#### 2) Grouping and clinical covariates

```{r eval=T, warning=F, cache=T}
# Get IDs of patients with longitudinal data
longitudinal.patients <- metadata[metadata$Dataset=="Longitudinal",]$Patient
acute.patients <- na.trim(df.nasal[df.nasal$Dataset=="1Acute" & df.nasal$keepacute=="Yes",]$Patient)
acute.samples <- na.trim(df.nasal$BCNasalbrushingmRNAAcute)

# Split datasets
host.nasal.long <- host.dge.nasal[,host.dge.nasal$targets$Patient %in% longitudinal.patients]
table(host.nasal.long$targets$Timepoint)

host.nasal.longw1Y <- host.dge.nasal[,!(colnames(host.dge.nasal) %in% acute.samples)]
table(host.nasal.longw1Y$targets$Group)
table(host.nasal.longw1Y$targets$Timepoint)

host.nasal.1Y <- host.dge.nasal[,host.dge.nasal$targets$Timepoint=="T4-1year" & !(colnames(host.dge.nasal) %in% acute.samples)]
table(host.nasal.1Y$targets$Group)

host.nasal.wheeze.1Y <- host.nasal.1Y[,host.nasal.1Y$Group=="Yes" & !(colnames(host.nasal.1Y) %in% acute.samples)]
```

### HOST LONGITUDINAL INVESTIGATION

#### 1) Principal coordinate analysis : Nasal

```{r eval=T, warning=F, cache=T}
# Perform PCA
PCA <- prcomp(t(host.nasal.long$E), center=TRUE)
varexp <- round(summary(PCA)$importance[2,1:2] * 100, digits = 0)

# Create dataset
data.PCA <- cbind(data.frame(Samples = rownames(PCA$x), PC1 = PCA$x[,1], PC2 = PCA$x[,2]), host.nasal.long$targets)

# Plot results
(plot.nasal.PCA.Age <- ggplot(data.PCA, aes(x = PC1, y = PC2)) +
  stat_ellipse(aes(fill = TimepointFactor), geom = "polygon", type = "t", level = 0.75, alpha = 0.2) +
  scale_shape_identity() +
  geom_xsidedensity(aes(y = after_stat(density), fill = TimepointFactor, color = TimepointFactor), size = 0.25) +
  geom_ysidedensity(aes(x = after_stat(density), fill = TimepointFactor, color = TimepointFactor), size = 0.25) +
  geom_point(aes(fill = TimepointFactor, color = TimepointFactor),
             shape = 21,
             #shape = ifelse(data.PCA$Group == "Yes" & data.PCA$TimepointFactor == "T4-1year", 25, 21),
             size = 2, stroke = 0.25) +
  annotate('text', x = min(data.PCA$PC1), y = min(data.PCA$PC2),
           label = paste0('Controls n = ', table(data.PCA$Group)[1], '\n',
                          'Wheezers n = ', table(data.PCA$Group)[2])) +
  scale_color_manual(values = adjustcolor(custom_palette_age, alpha = 1)) +
  scale_fill_manual(values = adjustcolor(custom_palette_age, alpha = 0.5)) +
  xlab(paste0("PC1 ", varexp[1], "%")) + ylab(paste0("PC2 ", varexp[2], "%")) +
  ggtitle("Longitudinal cohort : Nasal host gene expression PCA") +
  theme(ggside.panel.scale = 1/4,
        axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank(),
        legend.position = c(1, 0), legend.box.background=element_rect(), text=element_text(size=12)))

# Save plots
ggsave("../Figures/Individual/Host_PCA_Age.pdf", plot.nasal.PCA.Age, width = 20, height = 12, units = "cm", useDingbats = FALSE)
```

#### 2) Distance from previous timepoint

```{r eval=T, warning=F, cache=T}
(host.long.distance <- PlotDistanceTimepoint(host.nasal.long,  "Longitudinal cohort: Nasal host gene expression paired sample distance"))
```

#### 3) Differential gene expression analysis

```{r eval=T, warning=F, cache=T}
# Set parameters
FDR_param <- 0.1
FC_param <- 0

# Choose design
design <- model.matrix(~TimepointMonth, data=host.nasal.long$targets)
colnames(design)
corfit <- duplicateCorrelation(host.nasal.long$E, design, block=host.nasal.long$targets$Patient)

# Fit model and perform test
fit <- lmFit(host.nasal.long$E, design, correlation=corfit$consensus)
fit <- eBayes(fit)

# Get DE genes with age
DE_Age <- topTable(fit, coef=2, number="Inf")
DE_Age$Direction <- ifelse(DE_Age$logFC>FC_param & DE_Age$adj.P.Val<FDR_param, "Increase",
                           ifelse(-(DE_Age$logFC)>FC_param & DE_Age$adj.P.Val<FDR_param, "Decrease", ""))
table(DE_Age$Direction)

# Subset into immune genes and add labels
DE_Age$Immune <- ifelse(DE_Age$ID %in% ImmuneDB$name, "Yes", "No")
DE_Age$label <- NA
DE_Age$label <- ifelse(DE_Age$Direction!="" & DE_Age$Immune=="Yes", DE_Age$ID, NA)
table(DE_Age$Immune, DE_Age$Direction)

# Plot volcano
(plot.volcano.Age <- PlotVolcanoGenes(DE_Age, "Decrease", c("grey", custom_palette_age[1], custom_palette_age[3]), "Longitudinal cohort: Nasal host DE testing with age"))

# Save plots
ggsave("../Figures/Individual/Long_Volcano_Age.pdf", plot.volcano.Age, width=30, height=15, units="cm", useDingbats=FALSE)

# Save results to excel sheet
write.xlsx(DE_Age, "../Outputs/Age_DE_results.xlsx", row.names=FALSE)
```

#### 3) Pathway analysis of DE genes

```{r eval=T, warning=F, cache=T}
immune.pathway.age <- ImmunePathwayAnalysis(DE_Age)
plot.immune.pathway.age <- PlotImmunePathways(immune.pathway.age, palette = c(custom_palette_age[1], custom_palette_age[3]), number_pathways = 20, min_genecounts = 4, title = "Longitudinal cohort: Nasal host immune pathways with age")
```

### HOST COVARIATES INVESTIGATION

#### 1) Number of DE features with covariates

```{r eval=T, warning=F, cache=T}
# Calculate the number of DE features
host.nasal.covariates.counts <- DEfeaturesCounts(host.nasal.1Y, covariates.all)
host.nasal.covariates.counts
host.blood.covariates.counts <- DEfeaturesCounts(host.dge.blood, covariates.all)
host.blood.covariates.counts

# New variable names
newnames <- c("Antibiotics courses during pregnancy", "Any breastfeeding in the first year",
              "Weight at birth", "Gestational age at birth", "Delivery mode", 
              "Father history of asthma",  "Mother history of asthma", "Father history of hayfever", "Mother history of hayfever",
              "Sex", "Antibiotics courses in the first year", "More than 2 colds in the first year",
              "Sampling season", "Pets at home", "Number of siblings", "Daycare attendance in the first year")

# Results and reordering
host.nasal.covariates.counts$Newname <- rev(newnames)
host.blood.covariates.counts$Newname <- rev(newnames)

# Plot number of features
(host.nasal.covariates.plot <- PlotfeaturesCounts(host.nasal.covariates.counts, custom_palette_omics2[1],"1 year cohort : Nasal host DE features with covariates"))
(host.blood.covariates.plot <- PlotfeaturesCounts(host.blood.covariates.counts, custom_palette_omics2[2],"1 year cohort : Blood host DE features with covariates"))

# Genes with daycare
host.nasal.daycare <- host.nasal.1Y[,which(!is.na(host.nasal.1Y$targets$DayCare1YEAR))]
host.nasal.daycare.results <- topTable(eBayes(lmFit(host.nasal.daycare$E, model.matrix(formula(paste0("~", "DayCare1YEAR")), data=host.nasal.daycare$targets))), coef=2, number="Inf")
head(host.nasal.daycare.results)
```

#### 1) sbRDA variables selection

```{r}
# Select variables based on dbRDA
host.nasal.dbrda <- dbRDAselectionMaximum(host.nasal.1Y, covariates.all)
host.blood.dbrda <- dbRDAselectionMaximum(host.dge.blood, covariates.all)
host.nasal.dbrda
host.blood.dbrda
```

### HOST DISEASE INVESTIGATION

#### 1) Principal coordinate analysis : Nasal

```{r eval=T, warning=F, cache=T}
# Perform PCA.nasal
PCA.nasal <- prcomp(t(host.nasal.1Y$E), center=TRUE)
varexp <- c(summary(PCA.nasal)$importance[2, 1] * 100, summary(PCA.nasal)$importance[2, 2] * 100)
varexp <- round(varexp, digits = 0)

# Create dataset
data.PCA.nasal <- cbind(data.frame(Samples = rownames(PCA.nasal$x), PC1 = PCA.nasal$x[, 1], PC2 = PCA.nasal$x[, 2]), host.nasal.1Y$targets)

# Plot results
(plot.PCA.nasal.Disease <- ggplot(data.PCA.nasal, aes(x = PC1, y = PC2)) +
  stat_ellipse(aes(fill = Group), alpha = 0.2, geom = "polygon", type = "t", level = 0.75) + scale_shape_identity() +
  geom_xsidedensity(aes(y = after_stat(density), fill = Group, color = Group), size = 0.25) +
  geom_ysidedensity(aes(x = after_stat(density), fill = Group, color = Group), size = 0.25) +
  geom_point(aes(fill = Group, color = Group), shape = 21, size = 2, stroke = 0.25) +
  scale_color_manual(values = adjustcolor(custom_palette_2groups, alpha = 1)) +
  annotate('text', x=min(data.PCA.nasal$PC1), y=min(data.PCA.nasal$PC2),
             label=paste0('Controls n = ', table(data.PCA.nasal$Group)[1], '\n', 'Wheezers n = ', table(data.PCA.nasal$Group)[2])) +
  scale_fill_manual(values = adjustcolor(custom_palette_2groups, alpha = 0.5)) +
  xlab(paste0("PC1 ", varexp[1], "%")) + ylab(paste0("PC2 ", varexp[2], "%")) + ggtitle("1 year cohort : Nasal host PCA") +
  theme(legend.position = "bottom") +
  theme(ggside.panel.scale = 1 / 4, axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()))

# Save plots
ggsave("../Figures/Individual/Host_PCA_nasal_Disease.pdf", plot.PCA.nasal.Disease, width = 20, height = 12, units = "cm", useDingbats = FALSE)
```

#### 2) Principal coordinate analysis : Blood

```{r eval=T, warning=F, cache=T}
# Perform PCA.blood
PCA.blood <- prcomp(t(host.dge.blood$E), center=TRUE)
varexp <- c(summary(PCA.blood)$importance[2, 1] * 100, summary(PCA.blood)$importance[2, 2] * 100)
varexp <- round(varexp, digits = 0)

# Create dataset
data.PCA.blood <- cbind(data.frame(Samples = rownames(PCA.blood$x), PC1 = PCA.blood$x[, 1], PC2 = PCA.blood$x[, 2]), host.dge.blood$targets)

# Plot results
(plot.PCA.blood.Disease <- ggplot(data.PCA.blood, aes(x = PC1, y = PC2)) +
  stat_ellipse(aes(fill = Group), alpha = 0.2, geom = "polygon", type = "t", level = 0.75) + scale_shape_identity() +
  geom_xsidedensity(aes(y = after_stat(density), fill = Group, color = Group), size = 0.25) +
  geom_ysidedensity(aes(x = after_stat(density), fill = Group, color = Group), size = 0.25) +
  geom_point(aes(fill = Group, color = Group), shape = 21, size = 2, stroke = 0.25) +
  scale_color_manual(values = adjustcolor(custom_palette_2groups, alpha = 1)) +
  annotate('text', x=min(data.PCA.blood$PC1), y=min(data.PCA.blood$PC2),
             label=paste0('Controls n = ', table(data.PCA.blood$Group)[1], '\n', 'Wheezers n = ', table(data.PCA.blood$Group)[2])) +
  scale_fill_manual(values = adjustcolor(custom_palette_2groups, alpha = 0.5)) +
  xlab(paste0("PC1 ", varexp[1], "%")) + ylab(paste0("PC2 ", varexp[2], "%")) + ggtitle("1 year cohort : Blood host PCA") +
  theme(legend.position = "bottom") +
  theme(ggside.panel.scale = 1 / 4, axis.text.x = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()))

# Save plots
ggsave("../Figures/Individual/Host_PCA_blood_Disease.pdf", plot.PCA.blood.Disease, width = 20, height = 12, units = "cm", useDingbats = FALSE)
```

#### 3) Differential gene expression analysis : Nasal

DE testing with adjustment for covariates.

```{r eval=T, warning=F, cache=T}
# Choose design
design.nasal.adj <- model.matrix(~Group+DayCare1YEAR+Gender, data=host.nasal.1Y$targets)
colnames(design.nasal.adj)

# Get DE genes with age
DE_group_nasal_adj <- topTable(eBayes(lmFit(host.nasal.1Y$E, design.nasal.adj)), coef=2, number="Inf")
DE_group_nasal_adj$Direction <- ifelse(DE_group_nasal_adj$logFC>FC_param & DE_group_nasal_adj$adj.P.Val<FDR_param, "Wheeze",
                           ifelse(-(DE_group_nasal_adj$logFC)>FC_param & DE_group_nasal_adj$adj.P.Val<FDR_param, "Control", ""))
table(DE_group_nasal_adj$Direction)

# Add immune information
DE_group_nasal_adj$Immune <- ifelse(DE_group_nasal_adj$ID %in% ImmuneDB$name, "Yes", "No")

# Add labels for significant genes
DE_group_nasal_adj$label <- NA
DE_group_nasal_adj$label <- ifelse(DE_group_nasal_adj$Direction!="" & DE_group_nasal_adj$Immune=="Yes", DE_group_nasal_adj$ID, NA)
table(DE_group_nasal_adj$Direction, DE_group_nasal_adj$Immune)

# Plot volcano
(plot.volcano.nasal.Disease.adj <- PlotVolcanoGenes(DE_group_nasal_adj, "Control", c("grey", custom_palette_2groups), "1 year cohort : Nasal host DE genes with wheeze (adjusted for daycare attendance and sex)"))

# Save plots
ggsave("../Figures/Individual/Host_Volcano_Nasal_Disease_adj.pdf", plot.volcano.nasal.Disease.adj, width=30, height=15, units="cm", useDingbats=FALSE)

# Save results to excel sheet
write.xlsx(DE_group_nasal_adj, "../Outputs/Group_DE_nasal_ajusted_results.xlsx", row.names=FALSE)
```

DE testing without adjustment for covariates.

```{r eval=T, warning=F, cache=T}
# Choose design
design.nasal <- model.matrix(~Group, data=host.nasal.1Y$targets)
colnames(design.nasal)

# Get DE genes with age
DE_Group_nasal <- topTable(eBayes(lmFit(host.nasal.1Y$E, design.nasal)), coef=2, number="Inf")
DE_Group_nasal$Direction <- ifelse(DE_Group_nasal$logFC>FC_param & DE_Group_nasal$adj.P.Val<FDR_param, "Wheeze",
                           ifelse(-(DE_Group_nasal$logFC)>FC_param & DE_Group_nasal$adj.P.Val<FDR_param, "Control", ""))
table(DE_Group_nasal$Direction)

# Add immune information
DE_Group_nasal$Immune <- ifelse(DE_Group_nasal$ID %in% ImmuneDB$name, "Yes", "No")

# Add labels for significant genes
DE_Group_nasal$label <- NA
DE_Group_nasal$label <- ifelse(DE_Group_nasal$Direction!="" & DE_Group_nasal$Immune=="Yes", DE_Group_nasal$ID, NA)
table(DE_Group_nasal$Direction, DE_Group_nasal$Immune)

# Plot volcano
(plot.volcano.nasal.Disease <- PlotVolcanoGenes(DE_Group_nasal, "Control", c("grey", custom_palette_2groups), "1 year cohort : Nasal host DE genes with wheeze"))

# Save plots
ggsave("../Figures/Individual/Host_Volcano_Nasal_Disease.pdf", plot.volcano.nasal.Disease, width=30, height=15, units="cm", useDingbats=FALSE)

# Save results to excel sheet
write.xlsx(DE_Group_nasal, "../Outputs/Group_DE_nasal_results.xlsx", row.names=FALSE)
```

#### 4) Differential gene expression analysis : Blood

```{r eval=T, warning=F, cache=T}
# Choose design
design.blood <- model.matrix(~Group+Gender, data=host.dge.blood$targets)
colnames(design.blood)

# Get DE genes with age
DE_Group_blood <- topTable(eBayes(lmFit(host.dge.blood$E, design.blood)), coef=2, number="Inf")
DE_Group_blood$Direction <- ifelse(DE_Group_blood$logFC>FC_param & DE_Group_blood$adj.P.Val<FDR_param, "Wheeze",
                           ifelse(-(DE_Group_blood$logFC)>FC_param & DE_Group_blood$adj.P.Val<FDR_param, "Control", ""))
table(DE_Group_blood$Direction)

# Save results to excel sheet
write.xlsx(DE_Group_blood, "../Outputs/Group_DE_blood_results.xlsx", row.names=FALSE)
```

#### 5) Pathway analysis of DE genes

```{r}
immune.pathway.disease.adj <- ImmunePathwayAnalysis(DE_group_nasal_adj)
immune.pathway.disease <- ImmunePathwayAnalysis(DE_Group_nasal)
(immune.pathway.disease.plot <- PlotImmunePathways(immune.pathway.disease, palette = custom_palette_2groups, number_pathways = 5, min_genecounts = 4, title = "Test"))
```

### HOST LONGITUDINAL-DISEASE COMMONALITIES

```{r eval=T, warning=F, cache=T}
# Testing at each timepoint
LongitudinalBoxplots(host.nasal.long, DE_group_nasal_adj$label[!is.na(DE_group_nasal_adj$label)][1], "Longitudinal cohort : immune genes associated with disease at age 1")
LongitudinalBoxplots(host.nasal.long, DE_group_nasal_adj$label[!is.na(DE_group_nasal_adj$label)][2], "Longitudinal cohort : immune genes associated with disease at age 1")
LongitudinalBoxplots(host.nasal.long, DE_group_nasal_adj$label[!is.na(DE_group_nasal_adj$label)][3], "Longitudinal cohort : immune genes associated with disease at age 1")
LongitudinalBoxplots(host.nasal.long, DE_group_nasal_adj$label[!is.na(DE_group_nasal_adj$label)][4], "Longitudinal cohort : immune genes associated with disease at age 1")
LongitudinalBoxplots(host.nasal.long, DE_group_nasal_adj$label[!is.na(DE_group_nasal_adj$label)][5], "Longitudinal cohort : immune genes associated with disease at age 1")
LongitudinalBoxplots(host.nasal.long, DE_group_nasal_adj$label[!is.na(DE_group_nasal_adj$label)][6], "Longitudinal cohort : immune genes associated with disease at age 1")
LongitudinalBoxplots(host.nasal.long, DE_group_nasal_adj$label[!is.na(DE_group_nasal_adj$label)][7], "Longitudinal cohort : immune genes associated with disease at age 1")
```

# [**Multi-omics**]{.underline}

#### Multi-omics parameters

```{r}
# Set parameters for microbial data filtering and transformation
prev.omics <- 0.1
count.omics <- 1

# Prepare metadata file for longitudinal experiment
metaS <- metadata

metaS.1w <- metaS
metaS.1w$TimepointSimplified <- 0
rownames(metaS.1w) <- paste0("S", metaS.1w$Subjectnumber, ".week1")
metaS.1w$Timepoint <- round(round(day(as.period(interval(start=metaS.1w$ParticipantsDateofbirth,end=metaS.1w$DateofVisitBaseline), unit="days")), digits=1)/30.437, digits=1)

metaS.3m <- metaS
metaS.3m$TimepointSimplified <- 3
rownames(metaS.3m) <- paste0("S", metaS.3m$Subjectnumber, ".month3")
metaS.3m$Timepoint <- round(round(day(as.period(interval(start=metaS.3m$ParticipantsDateofbirth,end=metaS.3m$DateofVisit3MTH), unit="days")), digits=1)/30.437, digits=1)

metaS.6m <- metaS
metaS.6m$TimepointSimplified <- 6
rownames(metaS.6m) <- paste0("S", metaS.6m$Subjectnumber, ".month6")
metaS.6m$Timepoint <- round(round(day(as.period(interval(start=metaS.6m$ParticipantsDateofbirth,end=metaS.6m$DateofVisit6MTH), unit="days")), digits=1)/30.437, digits=1)

metaS.1y <- metaS
metaS.1y$TimepointSimplified <- 12
rownames(metaS.1y) <- paste0("S", metaS.1y$Subjectnumber, ".year1")
metaS.1y$Timepoint <- round(round(day(as.period(interval(start=metaS.1y$ParticipantsDateofbirth,end=metaS.1y$DateofVisit1YEAR), unit="days")), digits=1)/30.437, digits=1)

metaS.long <- rbind(metaS.1w, metaS.3m, metaS.6m, metaS.1y)

# Prepare metadata file for longitudinal experiment
rownames(metaS) <- paste0("S", metaS$Subjectnumber)
```

### LONGITUDINAL MULTI-OMICS

#### 1) Prepare datasets

```{r}
# Filter and transform bacterial data
bact.omics.long <- filter_taxa(bact.long, function(x) sum(x>count.omics) > (prev.omics*length(x)), TRUE)
otu_table(bact.omics.long) <- microbiome::transform(otu_table(bact.omics.long), transform="clr")  
hist(as.vector(OTUDataframe(bact.omics.long)), breaks = 200, col = "#5C1E91")

# Filter and transform fungal data
fung.omics.long <- filter_taxa(fung.long, function(x) sum(x>count.omics) > (prev.omics*length(x)), TRUE)
otu_table(fung.omics.long) <- microbiome::transform(otu_table(fung.omics.long), transform="clr")  
hist(as.vector(OTUDataframe(fung.omics.long)), breaks = 200, col = "#5C1E91")

# Save samples as column and features as rows
Bact.matrix.long <- OTUDataframe(bact.omics.long)
colnames(Bact.matrix.long) <- ifelse(SampleDataframe(bact.omics.long)$TimepointFactor == "T1-1week",
                                     paste0("S", SampleDataframe(bact.long)$Subject, ".week1"),
                                     ifelse(SampleDataframe(bact.omics.long)$TimepointFactor == "T2-3months",
                                     paste0("S", SampleDataframe(bact.long)$Subject, ".month3"),
                                     ifelse(SampleDataframe(bact.omics.long)$TimepointFactor == "T3-6months",
                                     paste0("S", SampleDataframe(bact.long)$Subject, ".month6"),
                                     paste0("S", SampleDataframe(bact.long)$Subject, ".year1"))))
Fung.matrix.long <- OTUDataframe(fung.omics.long)
colnames(Fung.matrix.long) <- ifelse(SampleDataframe(fung.omics.long)$TimepointFactor == "T1-1week",
                                     paste0("S", SampleDataframe(fung.long)$Subject, ".week1"),
                                     ifelse(SampleDataframe(fung.omics.long)$TimepointFactor == "T2-3months",
                                     paste0("S", SampleDataframe(fung.long)$Subject, ".month3"),
                                     ifelse(SampleDataframe(fung.omics.long)$TimepointFactor == "T3-6months",
                                     paste0("S", SampleDataframe(fung.long)$Subject, ".month6"),
                                     paste0("S", SampleDataframe(fung.long)$Subject, ".year1"))))
Vir.matrix.long <- OTUDataframe(vir.long)
colnames(Vir.matrix.long) <- ifelse(SampleDataframe(vir.long)$TimepointFactor == "T1-1week",
                                     paste0("S", SampleDataframe(vir.long)$Subject, ".week1"),
                                     ifelse(SampleDataframe(vir.long)$TimepointFactor == "T2-3months",
                                     paste0("S", SampleDataframe(vir.long)$Subject, ".month3"),
                                     ifelse(SampleDataframe(vir.long)$TimepointFactor == "T3-6months",
                                     paste0("S", SampleDataframe(vir.long)$Subject, ".month6"),
                                     paste0("S", SampleDataframe(vir.long)$Subject, ".year1"))))

# Prepare host longitudinal immune gene matrix
Host.matrix.long <- host.nasal.long$E[rownames(host.nasal.long$E) %in% ImmuneDB$name,]
colnames(Host.matrix.long) <- ifelse(host.nasal.long$targets$TimepointFactor == "T1-1week",
                                     paste0("S", host.nasal.long$targets$Subject, ".week1"),
                                     ifelse(host.nasal.long$targets$TimepointFactor == "T2-3months",
                                     paste0("S", host.nasal.long$targets$Subject, ".month3"),
                                     ifelse(host.nasal.long$targets$TimepointFactor == "T3-6months",
                                     paste0("S", host.nasal.long$targets$Subject, ".month6"),
                                     paste0("S", host.nasal.long$targets$Subject, ".year1"))))
rownames(Host.matrix.long) <- make.unique(rownames(Host.matrix.long))

# Create list of omics datasets
omicslist.long <- list(Nasal=as.matrix(Host.matrix.long), Bacteria=as.matrix(Bact.matrix.long), Fungi=as.matrix(Fung.matrix.long), Viruses=as.matrix(Vir.matrix.long))

# Create a MultiAssayExperiment object
omicsmae.long <- MultiAssayExperiment(experiments=omicslist.long, colData=DataFrame(metaS.long))
omicsmae.long
```

#### 2) MOFA

```{r eval=T, warning=F, cache=T}
# Create MOFA object
MOFAobject.long <- create_mofa(omicsmae.long)

# Set parameters
DataOptions <- get_default_data_options(MOFAobject.long)
ModelOptions <- get_default_model_options(MOFAobject.long)
ModelOptions$num_factors <- 3
TrainOptions <- get_default_training_options(MOFAobject.long)
TrainOptions$seed <- 2
MefistoOptions <- get_default_mefisto_options(MOFAobject.long)
MefistoOptions$scale_cov <- TRUE
set_covariates(MOFAobject.long, covariates = "Timepoint")

# Prepare MOFA and add time information
MOFAobject.long <- prepare_mofa(MOFAobject.long, data_options = DataOptions, model_options = ModelOptions, training_options = TrainOptions, mefisto_options = MefistoOptions)
MOFArun.long <- run_mofa(MOFAobject.long, use_basilisk = FALSE, save_data = FALSE)
```

#### 3) MOFA variance and factors

```{r}
# Reload MOFA results
(plot.data.overview.long <- plot_data_overview(MOFAobject.long, colors = custom_palette_omics1) +
    theme(legend.position = c(1, 0), legend.box.background=element_rect(), text=element_text(size=12)))
(plot.MOFA.var.long <- MOFAvarianceexplained(MOFArun.long, custom_palette_omics1, title = "Longitudinal cohort : MOFA variance explained"))

# Plot top factors
(MOFAfactorloadings(MOFArun.long, "Factor2", "Nasal", rep(custom_palette_omics1[2],2), 10, "Longitudinal cohort : Nasal host Factor2 MOFA loadings"))
(MOFAfactorloadings(MOFArun.long, "Factor2", "Bacteria", c(custom_palette_age[3], custom_palette_age[1]), 10, "Longitudinal cohort : Nasal bacteria Factor3 MOFA loadings"))
(MOFAfactorloadings(MOFArun.long, "Factor2", "Fungi", c(custom_palette_age[3], custom_palette_age[1]),  10, "Longitudinal cohort : Nasal host Factor3 MOFA loadings"))

# Plot factor value with age
(MOFAplotAge(MOFArun.long, "Factor2", custom_palette_age, "Longitudinal cohort : MOFA Factor3 with age"))
```

### DISEASE MULTI-OMICS

#### 1) Prepare datasets

```{r eval=T, warning=F, cache=T}
# Filter and transform bacterial data
bact.omics <- filter_taxa(bact.1Y, function(x) sum(x>count.omics) > (prev.omics*length(x)), TRUE)
otu_table(bact.omics) <- microbiome::transform(otu_table(bact.omics), transform="clr")  
hist(as.vector(OTUDataframe(bact.omics)), breaks = 200, col = "#5C1E91")

# Filter and transform fungal data
fung.omics <- filter_taxa(fung.1Y, function(x) sum(x>count.omics) > (prev.omics*length(x)), TRUE)
otu_table(fung.omics) <- microbiome::transform(otu_table(fung.omics), transform="clr")  
hist(as.vector(OTUDataframe(fung.omics)), breaks = 200, col = "#5C1E91")

# Save samples as column and features as rows
Bact.matrix <- OTUDataframe(bact.omics)
colnames(Bact.matrix) <- paste0("S", SampleDataframe(bact.1Y)$Subject)
Fung.matrix <- OTUDataframe(fung.omics)
colnames(Fung.matrix) <- paste0("S", SampleDataframe(fung.1Y)$Subject)
Vir.matrix <- OTUDataframe(vir.1Y)
colnames(Vir.matrix) <- paste0("S", SampleDataframe(vir.1Y)$Subject)

# Prepare nasal host matrix
Host.matrix.nasal <- host.nasal.1Y$E[rownames(host.nasal.1Y$E) %in% ImmuneDB$name,]
colnames(Host.matrix.nasal) <- paste0('S', host.nasal.1Y$targets$Subjectnumber)
rownames(Host.matrix.nasal) <- make.unique(rownames(Host.matrix.nasal))

# Prepare blood host matrix
Host.matrix.blood <- host.dge.blood$E[rownames(host.dge.blood$E) %in% ImmuneDB$name,]
colnames(Host.matrix.blood) <- paste0('S', host.dge.blood$targets$Subjectnumber)
rownames(Host.matrix.blood) <- make.unique(rownames(Host.matrix.blood))

# Create list of omics datasets
omicslist <- list(Nasal=as.matrix(Host.matrix.nasal), Blood=as.matrix(Host.matrix.blood), 
                  Bacteria=as.matrix(Bact.matrix), Fungi=as.matrix(Fung.matrix), Viruses=as.matrix(Vir.matrix))

# Create a MultiAssayExperiment object
omicsmae <- MultiAssayExperiment(experiments=omicslist, colData=DataFrame(metaS))
omicsmae
```

#### 2) MOFA

```{r eval=T, warning=F, cache=T}
# Create MOFA object
MOFAobject <- create_mofa(omicsmae)

# Set parameters
DataOptions <- get_default_data_options(MOFAobject)
ModelOptions <- get_default_model_options(MOFAobject)
ModelOptions$num_factors <- 3
TrainOptions <- get_default_training_options(MOFAobject)
TrainOptions$seed <- 2

# Run MOFA
MOFAobject <- prepare_mofa(MOFAobject, data_options = DataOptions, model_options = ModelOptions, training_options = TrainOptions)
MOFArun <- run_mofa(MOFAobject, use_basilisk = FALSE, save_data = FALSE)
```

#### 3) MOFA variance and factors

```{r eval=T, warning=F, cache=T}
# Reload MOFA results
(plot.data.overview <- plot_data_overview(MOFAobject, colors = custom_palette_omics2, covariate = "Bacteria") +
    ggtitle("1 year cohort : samples overlap") +
   theme(legend.position = c(1, 0), legend.box.background=element_rect(), text=element_text(size=12)))
(plot.MOFA.var <- MOFAvarianceexplained(MOFArun, custom_palette_omics2, title = "1 year cohort : MOFA variance explained"))

# Plot factor value with group
(plot.factor1.group <- BoxplotBinaryMOFAfactor(MOFArun, "Factor1", "Group", "Latent Factor1", custom_palette_2groups, custom_palette_2groups))
(plot.factor1.daycare <- BoxplotBinaryMOFAfactor(MOFArun, "Factor1", "DayCare1YEAR", "Latent Factor1", custom_palette_2groups, c("grey", "grey")))
(plot.factor1.daycaregroup <- BoxplotBinaryMOFAfactor4groups(MOFArun, "Factor1", "DayCareGroup", "Latent Factor1", custom_palette_2groups, c(rep(custom_palette_2groups[1],2), rep(custom_palette_2groups[2],2))))

# Plot factor 1 top features
(plot.factor1.nasal.loadings <- MOFAfactorloadings(MOFArun, "Factor1", "Nasal", custom_palette_2groups[2], 10, "1 year cohort : Nasal host Factor1 MOFA loadings"))
(plot.factor1.blood.loadings <- MOFAfactorloadings(MOFArun, "Factor1", "Blood", custom_palette_2groups[2], 10, "Factor1 : Blood host gene expression"))
(plot.factor1.bact.loadings <- MOFAfactorloadings(MOFArun, "Factor1", "Bacteria", custom_palette_2groups, 10, "Factor1 : Bacteria"))
```

#### 5) Nasal versus blood gene expression for key genes

```{r eval=T, warning=F, cache=T}
# Subset patients for which both blood and nasal gene expression are available
hostmae <- MultiAssayExperiment(experiments=list(Nasal=as.matrix(Host.matrix.nasal), Blood=as.matrix(Host.matrix.blood)), colData=DataFrame(metaS))
table(complete.cases(hostmae))
host.mae.complete <- hostmae[, complete.cases(hostmae), ]

# Create a dataframe with matching blood 
(nasal.blood.OSM <- CorrelationNasalBlood(host.mae.complete, gene = "OSM", title = "1 year cohort : Host nasal-blood OSM gene expression (matching samples)"))
(nasal.blood.AQP9 <- CorrelationNasalBlood(host.mae.complete, gene = "AQP9", title = "1 year cohort : Host nasal-blood AQP9 gene expression (matching samples)"))
(nasal.blood.ACVR1C <- CorrelationNasalBlood(host.mae.complete, gene = "ACVR1C", title = "1 year cohort : Host nasal-blood ACVR1C gene expression (matching samples)"))

# OSM with age
(nasal.OSM.long <- LongitudinalBoxplots(host.nasal.long, "OSM", "Longitudinal cohort : OSM gene"))
(nasal.AQP9.long <- LongitudinalBoxplots(host.nasal.long, "AQP9", "Longitudinal cohort : AQP9 gene"))
(nasal.ACVR1C.long <- LongitudinalBoxplots(host.nasal.long, "ACVR1C", "Longitudinal cohort : ACVR1C gene"))
```

#### 6) Key host genes-microbial correlations with age

### ***Figure 2***

Longitudinal analysis of all omics.

```{r eval=T, warning=F, cache=T}
(plot1 <- ggarrange(plot.nasal.PCA.Age, NA, bact.ordi.long, NA, fung.ordi.long,
                    ncol = 5, nrow = 1, align = "hv",
                    widths = c(1, 0.2, 1, 0.2, 1),
                    labels = c("a","","b", "", "c"),
                    font.label = list(size=20)))

(plot2 <-  ggarrange(host.long.distance, NA, bact.long.distance, NA, fung.long.distance,
                    ncol = 5, nrow = 1, align = "hv",
                    widths = c(1, 0.2, 1, 0.2, 1),
                    labels = c("d","", "e", "", "f"),
                    font.label = list(size=20)))

(plot3 <- ggarrange(virus.plot.detection.long, NA, virus.plot.details.long, NA, bact.Observed.age, NA, fung.Observed.age, 
                    ncol = 7, nrow = 1, align = "hv",
                    widths = c(1, 0.2, 1, 0.2, 1.25, 0.2, 1.25),
                    labels = c("g","", "h", "", "i", "", "j"),
                    font.label = list(size=20)))

(plot4 <- ggarrange(plot.volcano.Age, NA, plot.immune.pathway.age, NA, bact.long.age.bar, 
                    ncol = 5, nrow = 1, align = "hv",
                    widths = c(1.25, 0.2, 1, 0.2, 1),
                    labels = c("k","", "l", "", "m"),
                    font.label = list(size=20)))

(Figure2 <- ggarrange(plot1, plot2, plot3, plot4,
                      ncol = 1, nrow = 4, align = "hv",
                      heights = c(1, 1, 1, 1),
                      font.label = list(size=20)))

# Save figure
ggsave("../Figures/Main/Figure2.pdf", Figure2, width=50, height=45, units="cm", useDingbats=FALSE)
```

### ***Figure 3***

Covariates influencing the different omics at age 1.

```{r eval=T, warning=F, cache=T}


#host.nasal.covariates.plot host.blood.covariates.plot covariates.da.bact.plot covariates.da.fung.plot 
#bact.da.colds.bar bact.da.daycare.bar bact.da.siblings.bar fung.da.season.bar 

#all.cor.factors 
#alpha.bact.colds alpha.bact.abx alpha.bact.daycare alpha.bact.siblings alpha.fung.season 
#alpha.vir.daycare alpha.vir.abx alpha.vir.abxpregnancy alpha.vir.delivery

(plot1 <- all.cor.factors) 
(plot2 <- ggarrange(alpha.bact.colds, NA, alpha.bact.abx, NA, alpha.bact.daycare, NA, alpha.bact.siblings, NA, alpha.fung.season,
                    ncol = 9, nrow = 1, align = "hv",
                    widths = c(1, 0.2, 1, 0.2, 1, 0.2, 1, 0.2, 1),
                    labels = c("b","","c", "", "d", "", "e", "", "f"),
                    font.label = list(size=20)))
```

### ***Figure 3***

Different omics with with at age 1.

```{r eval=T, warning=F, cache=T}

```

### ***Figure 4***

Multiomics integration.

### ***Figure 5***

```{r eval=T, warning=F, cache=T}
(Figure6 <- ggarrange(plot.data.overview, NA, plot.mofa.explained, NA, r2f,
                        plot.host.loadings.factor3, NA, plot.bact.loadings.factor3, NA, plot.vir.loadings.factor3,
                        factor3.daycare.plot, NA, factor3.delivery.plot, NA, module23.age,
                        ncol=5, nrow=3,
                        widths=c(2, 0.2, 2, 0.2, 2),
                        labels=c("a","","b", "", "c", "d", "", "e", "","f", "g", "", "h", "","i"),
                        font.label=list(size=20)))

# Save figure
ggsave("../Figures/Main/Figure6.pdf", Figure6, width=40, height=30, units="cm", useDingbats=FALSE)
```

```{r render, eval=T}
# R
# Create a html report
rmarkdown::render('project-breathingtogether-group1.Rmd')
```
